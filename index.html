<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Yoyo å°„ç®­ (V35 åˆ†é ç‰ˆ)</title>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* --- å…¨å±€è®Šæ•¸ --- */
        :root {
            --primary-pink: #ffcbdb; --primary-blue: #a2d2ff; --primary-yellow: #fffdf5;
            --text-color: #5d4037; --stamp-red: #ff6b6b;
            --target-yellow: #ffe552; --target-red: #ff5252; --target-blue: #448aff;
            --target-black: #333333; --target-white: #ffffff;
            --font-main: 'Helvetica Rounded', Arial, sans-serif;
            /* å®‰å…¨å€åŸŸ */
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main); background-color: #f0f2f5;
            color: var(--text-color); margin: 0; padding: 0;
            /* é–å®š Body ä¸æ²å‹•ï¼Œåªè®“å…§éƒ¨çš„ scroll-content æ²å‹• */
            height: 100vh; height: 100dvh; 
            overflow: hidden; 
            display: flex; justify-content: center;
        }

        /* --- App å®¹å™¨ (Flex ç›´å‘æ’åˆ—) --- */
        .app-container {
            width: 100%; max-width: 600px; background: #fff; 
            height: 100%; 
            display: flex; flex-direction: column; /* é—œéµï¼šå‚ç›´æ’åˆ— */
            position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.1); 
        }
        .hidden { display: none !important; }

        /* --- Header (ä¸å†æ‡¸æµ®ï¼Œä½”ç”¨å¯¦é«”ç©ºé–“) --- */
        .header {
            background: var(--primary-pink); 
            min-height: 60px; /* åŸºç¤é«˜åº¦ */
            /* åŠ ä¸Šå®‰å…¨å€åŸŸé«˜åº¦ */
            padding-top: max(15px, var(--safe-top)); 
            padding-left: 15px; padding-right: 15px; padding-bottom: 10px;
            
            display: flex; align-items: flex-end; justify-content: space-between;
            flex-shrink: 0; /* ç¦æ­¢å£“ç¸® */
            z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 1.2rem; margin: 0; color: white; text-shadow: 1px 1px 0 var(--text-color); }
        .btn-header {
            background: rgba(255,255,255,0.95); border: none; color: var(--text-color);
            padding: 6px 15px; border-radius: 20px; font-weight: bold; cursor: pointer;
            font-size: 0.95rem; box-shadow: 0 2px 4px rgba(0,0,0,0.15); 
            display: flex; align-items: center; justify-content: center;
        }

        /* --- Toolbar (ä½”ç”¨å¯¦é«”ç©ºé–“) --- */
        .top-toolbar {
            background: #f5f5f5; height: 55px; 
            padding: 0 10px; 
            display: flex; align-items: center; justify-content: flex-start; gap: 10px; 
            flex-shrink: 0; /* ç¦æ­¢å£“ç¸® */
            border-bottom: 1px solid #ddd; overflow-x: auto; 
        }
        .btn-tool { background: white; border: 1px solid #ccc; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
        .round-selector { padding: 6px; border-radius: 15px; border: 2px solid var(--primary-blue); background: white; color: var(--text-color); font-weight: bold; font-size: 0.9rem; flex-shrink: 0;}
        .save-status { font-size: 0.75rem; color: #666; margin-left: auto; margin-right: 10px; white-space: nowrap; font-weight: bold; }

        /* --- æ–°å¢: åˆ†é å°è¦½åˆ— --- */
        .tab-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: white;
            padding: 0 15px;
            height: 50px;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
            z-index: 10;
        }
        .tab-btn {
            flex: 1;
            height: 100%;
            background: transparent;
            border: none;
            font-size: 1.05rem;
            font-weight: bold;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        .tab-btn.active {
            color: var(--text-color);
            border-bottom: 3px solid var(--primary-pink);
        }
        .tab-content {
            padding-top: 5px; 
        }
        .hidden-tab {
            display: none !important;
        }

        /* --- æ²å‹•å…§å®¹å€ (è‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“) --- */
        .scroll-content { 
            flex: 1; /* ä½”æ»¿ Header å’Œ Toolbar å‰©ä¸‹çš„æ‰€æœ‰ç©ºé–“ */
            overflow-y: auto; /* åªæœ‰é€™è£¡å¯ä»¥æ²å‹• */
            padding: 15px; 
            /* é—œéµï¼šè¶…å¤§åº•éƒ¨ç•™ç™½ï¼Œè®“å…§å®¹å¯ä»¥è¢«æ¨åˆ°éµç›¤ä¸Šæ–¹ */
            padding-bottom: 500px; 
            -webkit-overflow-scrolling: touch; 
            scroll-behavior: smooth;
        }

        /* --- ç™»å…¥é é¢ä¿®æ­£ --- */
        /* ç¢ºä¿ç™»å…¥é å…§å®¹ä¸æœƒå¤ªé ä¸Š */
        .login-view-content {
            display: flex; flex-direction: column; align-items: center; padding-top: 20px;
        }

        /* --- å…¶ä»–çµ„ä»¶ --- */
        .mascot-area { font-size: 80px; margin-bottom: 10px; }
        .login-area { background: white; padding: 25px; border-radius: 20px; width: 90%; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 2px solid #eee; text-align: center; }
        .login-input { width: 100%; padding: 15px; font-size: 1.2rem; border: 2px solid var(--primary-blue); border-radius: 15px; text-align: center; margin-bottom: 15px; outline: none; }
        .home-btn { display: block; width: 100%; padding: 15px; border-radius: 30px; border: 2px solid var(--text-color); font-size: 1.1rem; font-weight: bold; cursor: pointer; background: white; color: var(--text-color); box-shadow: 0 4px 0 #ddd; margin-bottom: 15px; }
        .btn-pink { background: var(--primary-pink); color: white; border: none; }
        .btn-blue { background: var(--primary-blue); color: white; border: none; }

        .avatar-circle { width: 80px; height: 80px; border-radius: 50%; background: white; border: 3px solid var(--primary-pink); display: flex; align-items: center; justify-content: center; font-size: 3rem; margin: 0 auto 15px auto; cursor: pointer; }
        
        /* --- åˆ—è¡¨èˆ‡å¡ç‰‡ --- */
        .student-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 20px; }
        .student-card { background: white; border: 2px solid var(--primary-blue); border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; box-shadow: 0 4px 0 #dbeafe; }
        .history-card { background: white; border: 1px solid #eee; border-left: 5px solid var(--primary-blue); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .history-info { display: flex; justify-content: space-between; align-items: center; }
        .h-title { font-weight: bold; font-size: 1.1rem; }
        .h-stats { font-size: 0.9rem; color: #666; margin-top: 5px; }
        .btn-delete-record { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; margin-left: 10px; }

        /* --- è¨ˆåˆ†è¡¨æ ¼ --- */
        .score-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; background: white; border-radius: 8px; overflow: hidden; font-size: 0.9rem; }
        .score-table th { background: var(--primary-blue); color: white; padding: 8px 2px; }
        .score-table td { border: 1px solid #ddd; height: 42px; padding: 0; text-align: center; }
        .score-cell { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
        .score-cell.active { box-shadow: inset 0 0 0 3px var(--primary-pink); }
        .bg-yellow { background-color: var(--target-yellow); } .bg-red { background-color: var(--target-red); } .bg-blue { background-color: var(--target-blue); } .bg-black { background-color: var(--target-black); color: white !important; text-shadow: 0 0 2px black; } .bg-white { background-color: var(--target-white); }

        /* --- éµç›¤ (æ‡¸æµ®åº•éƒ¨) --- */
        .keypad-container { 
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 600px;
            background: white; padding: 8px; padding-bottom: calc(8px + var(--safe-bottom));
            box-shadow: 0 -4px 15px rgba(0,0,0,0.15); 
            z-index: 100; display: flex; flex-direction: column; gap: 5px; 
            height: 260px; transition: transform 0.3s ease; 
        }
        .keypad-container.hidden-keypad { transform: translate(-50%, 110%); }
        .key-row { display: flex; gap: 4px; height: 100%; max-height: 55px; }
        .key-btn { flex: 1; border: none; border-radius: 6px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
        .k-y { background: var(--target-yellow); } .k-r { background: var(--target-red); color: white; } .k-b { background: var(--target-blue); color: white; } .k-bk { background: var(--target-black); color: white; } .k-w { background: white; border: 1px solid #ccc; } .k-del { background: #ffcdd2; color: #d32f2f; flex: 1.5; } .k-nav { background: var(--primary-pink); color: white; font-size: 1rem; }

        /* --- å…¶ä»– --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 10px; }
        .cal-day { aspect-ratio: 0.9; background: white; border: 1px solid #eee; border-radius: 8px; padding: 2px; position: relative; cursor: pointer; }
        .cal-day.today { border: 2px solid var(--primary-blue); background: #f0f8ff; }
        .stamp-mark { position: absolute; bottom: 2px; right: 2px; font-size: 18px; }
        .cal-scores { font-size: 0.6rem; color: #666; }

        .pdf-area { background: white; padding: 10px; border-radius: 10px; border: 1px solid #eee; }
        .photo-section { margin-top: 15px; padding: 10px; border: 2px dashed #ccc; border-radius: 10px; text-align: center; }
        .photo-preview { max-width: 100%; margin-top: 10px; border-radius: 8px; }
        .summary-row { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin: 10px 0; }
        .stats-box { background: #e3f2fd; color: #1565c0; padding: 10px; border-radius: 10px; font-weight: bold; }
        .total-display { background: var(--primary-pink); color: white; padding: 10px; border-radius: 10px; font-weight: bold; font-size: 1.3rem; }
        .comment-box { width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-top: 5px; }

        /* ç°½åå€æ¨£å¼ */
        .signature-area {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .sig-box {
            flex: 1;
            border: 1px dashed #ccc;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #fcfcfc;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column; font-weight: bold; color: var(--text-color); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-pink); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; display: flex; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; text-align: center; width: 85%; max-width: 350px; }
        .emoji-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; max-height: 300px; overflow-y: auto; padding: 10px; }
        .emoji-btn { font-size: 2rem; cursor: pointer; padding: 5px; background: #f9f9f9; border-radius: 5px; }
        
        /* å›é ‚æŒ‰éˆ• */
        .btn-back-to-top {
            position: fixed; bottom: 280px; left: 50%; margin-left: 240px;
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(255, 203, 219, 0.95); color: white; border: 2px solid white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 150; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        @media (max-width: 600px) { .btn-back-to-top { left: auto; right: 20px; margin-left: 0; } }
        .btn-back-to-top.visible { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="loading" class="loading-overlay hidden"><div class="spinner"></div><div id="loading-text">é€£ç·šä¸­...</div></div>
    <div id="back-to-top" class="btn-back-to-top" onclick="scrollToTop()">â¬†ï¸</div>

    <div id="view-home">
        <div class="header"><h1>ğŸ¹ Yoyo å°„ç®­ (Cloud)</h1></div>
        <div class="scroll-content">
            <div class="login-view-content">
                <div class="mascot-area">ğŸ» ğŸ¯ ğŸ°</div>
                <h2 style="margin-bottom: 5px;">æ­¡è¿å›ä¾†ï¼</h2>
                <p style="color:#888; font-weight:bold; color:var(--stamp-red);">è«‹è¼¸å…¥åå­—åŠé ­åƒï¼ˆéœ€æ¯æ¬¡éƒ½ç›¸åŒï¼‰</p>
                <div class="login-area">
                    <div id="current-avatar-btn" class="avatar-circle" onclick="openEmojiSelector()">ğŸ»</div>
                    <input type="text" id="archer-name-input" class="login-input" placeholder="è«‹è¼¸å…¥åå­—">
                    <button class="home-btn btn-pink" onclick="loginArcher()">æˆ‘æ˜¯å°„æ‰‹ (ç™»å…¥)</button>
                    <button class="home-btn btn-blue" onclick="openLogin()">æˆ‘æ˜¯æ•™ç·´ (ç®¡ç†)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-coach-dashboard" class="hidden">
        <div class="header">
            <button class="btn-header" onclick="navTo('view-home')">ç™»å‡º</button><h1>å­¸ç”Ÿåå–®</h1><button class="btn-header" onclick="loadAllArchers()">ğŸ”„</button>
        </div>
        <div class="scroll-content">
            <div id="student-list-container" class="student-list"></div>
        </div>
    </div>

    <div id="view-student-history" class="hidden">
        <div class="header">
            <button class="btn-header" onclick="handleHistoryBack()">è¿”å›</button><h1>æˆç¸¾ç¸½è¦½</h1><div style="width: 50px;"></div>
        </div>
        <div class="scroll-content">
            <h3 id="history-archer-name" style="text-align: center;"></h3>
            <div id="history-list-container"></div>
            <button class="home-btn btn-blue" onclick="navTo('view-calendar')">ğŸ“… æ–°ç´€éŒ„</button>
            <div style="margin-top:20px; text-align:center;">
                <button class="btn-danger" style="background:#c62828; color:white; border:none; padding:10px; border-radius:10px;" onclick="clearAllRecords()">âš ï¸ æ¸…ç©ºç´€éŒ„</button>
            </div>
        </div>
    </div>

    <div id="view-calendar" class="hidden">
        <div class="header">
            <button class="btn-header" onclick="handleCalendarBack()">è¿”å›</button><h1>è¡Œäº‹æ›†</h1><div style="width: 50px;"></div>
        </div>
        <div class="scroll-content">
            <div style="display:flex; justify-content:space-between; padding: 10px;">
                <button onclick="changeMonth(-1)">â—€</button>
                <h2 id="month-display" style="margin:0;"></h2>
                <button onclick="changeMonth(1)">â–¶</button>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
    </div>

    <div id="view-score" class="hidden">
        <div class="header">
            <button class="btn-header" onclick="goBackFromScore()">è¿”å›</button>
            <h1>è¨ˆåˆ†æ¿</h1>
            <button class="btn-header" style="color:var(--stamp-red);" onclick="saveCurrentRound()">å„²å­˜</button>
        </div>
        <div class="top-toolbar">
            <select id="round-selector" class="round-selector" onchange="switchRound()"></select>
            <span id="save-status" class="save-status"></span>
            <button class="btn-tool" onclick="exportPDF()">ğŸ“„</button>
            <button class="btn-tool" onclick="toggleKeypad()">âŒ¨ï¸</button>
        </div>
        
        <div class="tab-bar">
            <button class="tab-btn active" id="tab-btn-score" onclick="switchTab('score')">ğŸ“Š è¨ˆåˆ†</button>
            <button class="tab-btn" id="tab-btn-summary" onclick="switchTab('summary')">ğŸ“ ç¸½è¦½</button>
        </div>
        <div class="scroll-content">
            <div id="pdf-export-area" class="pdf-area">
                
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span id="date-label" style="font-weight:bold;"></span>
                    <span id="pdf-archer-name"></span>
                </div>

                <div id="tab-content-score" class="tab-content">
                    
                    <div style="margin-bottom:10px; text-align:center;">
                        <span id="round-label-display" style="color:red; font-weight:bold;"></span>
                    </div>

                    <table class="score-table"><thead><tr id="table-head-row"></tr></thead><tbody id="table-body"></tbody></table>

                    <div class="summary-row">
                        <div class="stats-box" id="stats-display">10+X: 0 | X: 0</div>
                        <div class="total-display">ç¸½åˆ†: <span id="grand-total">0</span></div>
                    </div>
                </div>

                <div id="tab-content-summary" class="tab-content hidden-tab">
                    
                    <div style="margin-bottom:15px;">
                        <label style="font-weight: bold;">ğŸ¹ å¼“ç¨®èˆ‡è³½åˆ¶ï¼š</label>
                        <select id="bow-selector" onchange="triggerAutoSave()">
                            <option value="recurve">åæ›²å¼“</option><option value="compound">è¤‡åˆå¼“</option>
                        </select>
                        <select id="mode-select" onchange="initScoreTable()">
                            <option value="outdoor">å®¤å¤– (36ç®­)</option><option value="indoor">å®¤å…§ (30ç®­)</option>
                        </select>
                    </div>

                    <div class="signature-area">
                        <div class="sig-box" onclick="handleSign('archer')"><div id="sig-archer" class="sig-placeholder">å°„æ‰‹ç°½åˆ°</div></div>
                        <div class="sig-box" onclick="handleSign('coach')"><div id="sig-coach" class="sig-placeholder">æ•™ç·´ç°½ç½²</div></div>
                    </div>
                    
                    <div style="margin-top:15px;">
                        <label style="font-weight: bold;">ğŸ“‹ è©•èªï¼š</label>
                        <textarea id="coach-comment" class="comment-box" placeholder="è«‹è¼¸å…¥..."></textarea>
                    </div>

                    <div class="photo-section">
                        <button class="btn-camera" onclick="document.getElementById('target-photo-input').click()">ğŸ“· æ‹æ”/ä¸Šå‚³é¶ç´™</button>
                        <input type="file" id="target-photo-input" accept="image/*" style="display:none;" onchange="handlePhotoUpload(event)">
                        <div id="photo-preview-container" style="display:none; margin-top:10px;">
                            <img id="photo-preview" class="photo-preview" src="">
                            <button onclick="deletePhoto()" style="color:red;">åˆªé™¤ç…§ç‰‡</button>
                        </div>
                    </div>
                </div>

                <div style="text-align:center; margin-top:20px; color:#ccc; font-size:0.7rem;">Generated by Yoyo Archery App</div>
            </div>
        </div>
        
        <div class="keypad-container" id="keypad">
            <div class="key-row"><button class="key-btn k-y" onclick="inputScore('X')">X</button><button class="key-btn k-y" onclick="inputScore(10)">10</button><button class="key-btn k-y" onclick="inputScore(9)">9</button></div>
            <div class="key-row"><button class="key-btn k-r" onclick="inputScore(8)">8</button><button class="key-btn k-r" onclick="inputScore(7)">7</button><button class="key-btn k-b" onclick="inputScore(6)">6</button><button class="key-btn k-b" onclick="inputScore(5)">5</button></div>
            <div class="key-row"><button class="key-btn k-bk" onclick="inputScore(4)">4</button><button class="key-btn k-bk" onclick="inputScore(3)">3</button><button class="key-btn k-w" onclick="inputScore(2)">2</button><button class="key-btn k-w" onclick="inputScore(1)">1</button></div>
            <div class="key-row"><button class="key-btn k-w" onclick="inputScore('M')">M</button><button class="key-btn k-del" onclick="deleteScore()">â¬…</button><button class="key-btn k-nav" onclick="moveFocus(1)">ä¸‹ä¸€æ ¼</button></div>
        </div>
    </div>

    <div id="emoji-modal" class="hidden modal-overlay"><div class="modal-box"><h3>é¸æ“‡é ­åƒ</h3><div class="emoji-grid" id="emoji-grid"></div><button style="margin-top:15px;" onclick="closeEmojiSelector()">å–æ¶ˆ</button></div></div>
    <div id="login-modal" class="hidden modal-overlay"><div class="modal-box"><h3>æ•™ç·´ç™»å…¥</h3><input type="password" id="coach-pwd" class="login-input" placeholder="å¯†ç¢¼"><button class="home-btn btn-blue" onclick="checkLogin()">ç™»å…¥</button><button onclick="closeLogin()">å–æ¶ˆ</button></div></div>

</div>

<script>
    // --- 1. FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyBfy1pe_3WIigOpZXXI3kASKqhxEsHWGO8",
      authDomain: "yoyo-archery-app.firebaseapp.com",
      projectId: "yoyo-archery-app",
      storageBucket: "yoyo-archery-app.firebasestorage.app",
      messagingSenderId: "540788690338",
      appId: "1:540788690338:web:6bed490f095102a8baf6fb",
      measurementId: "G-99R8BXR4L2"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 2. é‚è¼¯ ---
    let currentRole='archer', currentArcherName='', currentArcherAvatar='ğŸ»';
    let selectedDate = new Date().toISOString().split('T')[0];
    let displayMonth = new Date();
    let currentRoundData={}, currentRoundIdx=0, localCacheData={};
    let lastView = 'view-home'; let autoSaveTimer = null; 

    // V35 æ²å‹•é‚è¼¯
    function setupScrollListener() { 
        const els = document.querySelectorAll('.scroll-content'); 
        const btn = document.getElementById('back-to-top'); 
        els.forEach(el => { 
            el.onscroll = function() { 
                if (!el.parentElement.classList.contains('hidden') && el.scrollTop > 300) btn.classList.add('visible'); 
                else btn.classList.remove('visible'); 
            }; 
        }); 
    }
    function scrollToTop() { const v = document.querySelector('.app-container > div:not(.hidden) .scroll-content'); if(v) v.scrollTo({ top: 0, behavior: 'smooth' }); }
    setupScrollListener();

    function showLoading(show, text="é€£ç·šä¸­...") { const el = document.getElementById('loading'); document.getElementById('loading-text').innerText = text; if(show) el.classList.remove('hidden'); else el.classList.add('hidden'); }
    function loadCloudData(name, cb) { showLoading(true, `è®€å– ${name}...`); db.collection("records").doc(name).get().then((doc) => { if (doc.exists) { const d = doc.data(); localCacheData = d.appData ? JSON.parse(d.appData) : {}; } else { localCacheData = {}; } showLoading(false); if(cb) cb(); }).catch((e) => { showLoading(false); alert("è®€å–å¤±æ•—"); }); }
    function saveToCloud(cb, isSilent=false) { if(!currentArcherName) return; if (!isSilent) showLoading(true, "å„²å­˜ä¸­..."); else document.getElementById('save-status').innerText = "â³..."; db.collection("records").doc(currentArcherName).set({ avatar: currentArcherAvatar, appData: JSON.stringify(localCacheData), lastUpdate: firebase.firestore.FieldValue.serverTimestamp() }).then(() => { if (!isSilent) showLoading(false); if (isSilent) { const t = new Date().toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit', second:'2-digit' }); document.getElementById('save-status').innerText = "âœ… " + t; } if(cb) cb(); }).catch((e) => { if (!isSilent) { showLoading(false); alert("å„²å­˜å¤±æ•—"); } else document.getElementById('save-status').innerText = "âŒ"; }); }
    function triggerAutoSave() { document.getElementById('save-status').innerText = "ğŸ“..."; clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(() => { saveCurrentRound(true); }, 1000); }

    // --- UI ---
    const avatars = ['ğŸ»','ğŸ°','ğŸ±','ğŸ¶','ğŸ¦','ğŸ¯','ğŸ¼','ğŸ¨','ğŸ·','ğŸ¸','ğŸ¹','ğŸ¯'];
    function openEmojiSelector() { const g=document.getElementById('emoji-grid'); g.innerHTML=""; avatars.forEach(e => { const b=document.createElement('div'); b.className='emoji-btn'; b.innerText=e; b.onclick=()=>selectAvatar(e); g.appendChild(b); }); document.getElementById('emoji-modal').classList.remove('hidden'); }
    function closeEmojiSelector() { document.getElementById('emoji-modal').classList.add('hidden'); }
    function selectAvatar(e) { currentArcherAvatar=e; document.getElementById('current-avatar-btn').innerText=e; closeEmojiSelector(); }

    function navTo(id, role) {
        if(role) currentRole = role;
        document.querySelectorAll('.app-container > div').forEach(d => { if(!d.classList.contains('loading-overlay') && d.id!=='back-to-top') d.classList.add('hidden'); });
        document.getElementById(id).classList.remove('hidden');
        if(id==='view-calendar') renderCalendar();
        
        // æ³¨æ„ï¼šåœ¨ openScore ä¸­æœƒè™•ç†éµç›¤é¡¯ç¤º
        if(id!=='view-score') document.getElementById('keypad').classList.add('hidden-keypad');
        
        const color = currentRole === 'coach' ? 'var(--primary-blue)' : 'var(--primary-pink)';
        document.querySelectorAll('.header').forEach(h => h.style.background = color);
        document.getElementById('back-to-top').classList.remove('visible');
    }

    // æ–°å¢ï¼šåˆ†é åˆ‡æ›é‚è¼¯
    function switchTab(tabName) {
        // éš±è—æ‰€æœ‰åˆ†é å…§å®¹
        document.getElementById('tab-content-score').classList.add('hidden-tab');
        document.getElementById('tab-content-summary').classList.add('hidden-tab');
        
        // ç§»é™¤æ‰€æœ‰åˆ†é æŒ‰éˆ•çš„ active ç‹€æ…‹
        document.getElementById('tab-btn-score').classList.remove('active');
        document.getElementById('tab-btn-summary').classList.remove('active');

        // é¡¯ç¤ºç›®æ¨™åˆ†é å…§å®¹
        document.getElementById(`tab-content-${tabName}`).classList.remove('hidden-tab');
        
        // è¨­ç½®ç›®æ¨™åˆ†é æŒ‰éˆ•ç‚º active
        document.getElementById(`tab-btn-${tabName}`).classList.add('active');

        // åˆ‡æ›éµç›¤é¡¯ç¤ºï¼šåªæœ‰åœ¨ 'score' åˆ†é æ‰é¡¯ç¤ºéµç›¤
        const keypad = document.getElementById('keypad');
        if (tabName === 'score') {
            keypad.classList.remove('hidden-keypad');
            // åˆ‡æ›åˆ°è¨ˆåˆ†é æ™‚ï¼Œå¦‚æœ scroll-content å­˜åœ¨ï¼Œå‰‡è‡ªå‹•æ²å‹•åˆ°è¡¨æ ¼é ‚éƒ¨
            const scrollContent = document.querySelector('#view-score .scroll-content');
            if (scrollContent) scrollContent.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
            keypad.classList.add('hidden-keypad');
        }
    }


    function loginArcher() { const n = document.getElementById('archer-name-input').value.trim(); if(!n) return alert("è«‹è¼¸å…¥åå­—"); currentArcherName = n; updateLabels(); loadCloudData(n, () => { renderHistory(n, currentArcherAvatar); navTo('view-student-history', 'archer'); }); }
    function updateLabels() { document.getElementById('pdf-archer-name').innerText = `å°„æ‰‹: ${currentArcherAvatar} ${currentArcherName}`; }
    function handleHistoryBack() { navTo(currentRole==='coach' ? 'view-coach-dashboard' : 'view-home'); }
    function handleCalendarBack() { navTo('view-student-history'); }
    
    function goBackFromScore() { 
        document.getElementById('keypad').classList.add('hidden-keypad'); // ç¢ºä¿éµç›¤éš±è—
        navTo('view-calendar'); 
    }

    function openLogin() { document.getElementById('login-modal').classList.remove('hidden'); } function closeLogin() { document.getElementById('login-modal').classList.add('hidden'); } function checkLogin() { if(document.getElementById('coach-pwd').value === '7201440') { closeLogin(); navTo('view-coach-dashboard', 'coach'); loadAllArchers(); } else { alert("å¯†ç¢¼éŒ¯èª¤"); } }
    
    function loadAllArchers() { showLoading(true); db.collection("records").get().then(snap => { const c = document.getElementById('student-list-container'); c.innerHTML=""; snap.forEach(doc => { const n = doc.id; const d = doc.data(); const a = d.avatar || 'ğŸ»'; const div = document.createElement('div'); div.className='student-card'; div.innerHTML = `<span class="student-icon">${a}</span><div class="student-name">${n}</div>`; div.onclick = () => { currentArcherName=n; currentArcherAvatar=a; updateLabels(); loadCloudData(n, () => { renderHistory(n, a); navTo('view-student-history', 'coach'); }); }; c.appendChild(div); }); showLoading(false); }).catch(e => { showLoading(false); alert("éŒ¯èª¤"); }); }

    function renderHistory(n, a) {
        document.getElementById('history-archer-name').innerText = `${a} ${n} çš„ç´€éŒ„`;
        const c = document.getElementById('history-list-container'); c.innerHTML="";
        const list = [];
        Object.keys(localCacheData).forEach(date => { const d = localCacheData[date]; if(d.rounds) d.rounds.forEach((r, i) => list.push({date, idx: i, data: r})); });
        list.sort((x,y) => new Date(y.date) - new Date(x.date));
        if(list.length===0) c.innerHTML="<p style='text-align:center;color:#999'>ç„¡ç´€éŒ„</p>";
        list.forEach(item => {
            const r = item.data;
            let arrowCnt = 0; if(r.scores) r.scores.forEach(row => row.forEach(v => { if(v!==null && v!=="") arrowCnt++; }));
            const tot = parseInt(r.total)||0;
            const avg = arrowCnt>0 ? (tot/arrowCnt).toFixed(1) : "0.0";
            const modeT = r.mode==='indoor'?'å®¤å…§':'å®¤å¤–'; const bowT = r.bowType==='compound'?'è¤‡åˆå¼“':'åæ›²å¼“';
            let comm = r.comment ? `<div class="h-comment">ğŸ’¬ ${r.comment}</div>` : '';
            const div = document.createElement('div'); div.className='history-card';
            div.innerHTML = `<div class="history-info" onclick="openScore('${item.date}', ${item.idx})"><div><div class="h-date">${item.date} â€¢ R${item.idx+1} (${bowT})</div><div class="h-title">${modeT} (${arrowCnt}ç®­)</div><div class="h-stats"><span class="stat-badge">ç¸½åˆ†:${tot}</span><span class="stat-badge stat-avg">å‡:${avg}</span>${r.coachSigned?' <span class="stat-badge" style="color:red">ğŸ’®</span>':''}</div></div><div style="font-size:1.5rem;color:#ccc">â€º</div></div><div style="display:flex; justify-content:flex-end; margin-top:5px;"><button class="btn-delete-record" onclick="deleteRound('${item.date}', ${item.idx}, event)">ğŸ—‘ï¸</button></div>${comm}`;
            c.appendChild(div);
        });
    }
    function deleteRound(d, i, e) { e.stopPropagation(); if(!confirm("åˆªé™¤?")) return; let dd = localCacheData[d]; dd.rounds.splice(i, 1); if(dd.rounds.length===0) delete localCacheData[d]; saveToCloud(() => renderHistory(currentArcherName, currentArcherAvatar)); }
    function clearAllRecords() { if(confirm("æ¸…ç©ºæ‰€æœ‰?")) { localCacheData={}; saveToCloud(() => renderHistory(currentArcherName, currentArcherAvatar)); } }

    function renderCalendar() { const g=document.getElementById('calendar-grid'); g.innerHTML=""; const y=displayMonth.getFullYear(); const m=displayMonth.getMonth(); document.getElementById('month-display').innerText = `${y}å¹´ ${m+1}æœˆ`; const dim = new Date(y, m+1, 0).getDate(); const first = new Date(y, m, 1).getDay(); for(let i=0; i<first; i++) g.appendChild(document.createElement('div')); for(let d=1; d<=dim; d++) { const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const el = document.createElement('div'); el.className='cal-day'; el.innerHTML = `<div style="font-size:0.8rem;font-weight:bold;">${d}</div>`; if(ds===new Date().toISOString().split('T')[0]) el.style.border="2px solid var(--primary-blue)"; const dd = localCacheData[ds]; if(dd && dd.rounds && dd.rounds.length>0) { el.style.background='#fffbe6'; const sl = document.createElement('div'); sl.className='cal-scores'; dd.rounds.forEach((r, i) => { if(i<2) sl.innerHTML += `<div>R${i+1}: ${r.total}</div>`; }); el.appendChild(sl); } el.onclick = () => openScore(ds); g.appendChild(el); } }
    function changeMonth(d) { displayMonth.setMonth(displayMonth.getMonth()+d); renderCalendar(); }

    function openScore(dateStr, idx=null) {
        selectedDate = dateStr; document.getElementById('date-label').innerText = dateStr; document.getElementById('save-status').innerText = "";
        let dd = localCacheData[dateStr]; if(!dd || !dd.rounds) dd = { rounds: [] };
        if(dd.rounds.length === 0) createNewRound(dd);
        currentRoundIdx = (idx!==null) ? idx : dd.rounds.length-1; localCacheData[dateStr] = dd;
        renderRoundSelector(dd); loadRound(dd.rounds[currentRoundIdx]);
        
        // é è¨­åˆ‡æ›åˆ° 'score' åˆ†é ï¼Œä¸¦é¡¯ç¤ºéµç›¤
        switchTab('score'); 
        
        document.getElementById('coach-comment').readOnly = (currentRole==='archer'); navTo('view-score');
    }
    function createNewRound(dd) { dd.rounds.push({mode:'outdoor', bowType:'recurve', scores:null, total:0, comment:'', archerSigned:false, coachSigned:false, targetPhoto:null}); return dd.rounds.length-1; }
    function renderRoundSelector(dd) { const s = document.getElementById('round-selector'); s.innerHTML=""; dd.rounds.forEach((r, i) => { const o=document.createElement('option'); o.value=i; o.text=`R${i+1} (${r.total})`; s.appendChild(o); }); const add = document.createElement('option'); add.value="new"; add.text="â•"; s.appendChild(add); s.value = currentRoundIdx; }
    function switchRound() { const v = document.getElementById('round-selector').value; saveCurrentRound(true); let dd = localCacheData[selectedDate]; if(v==='new') { if(confirm("æ–°ä¸€è¼ª?")) { currentRoundIdx=createNewRound(dd); renderRoundSelector(dd); loadRound(dd.rounds[currentRoundIdx]); } else document.getElementById('round-selector').value = currentRoundIdx; } else { currentRoundIdx = parseInt(v); loadRound(dd.rounds[currentRoundIdx]); } }
    
    function loadRound(r) {
        currentRoundData = r;
        // é¸æ“‡å™¨å·²ç§»åˆ° summary tabï¼Œæ­¤è™•åƒ…è®€å–å€¼
        document.getElementById('mode-select').value = r.mode || 'outdoor'; document.getElementById('bow-selector').value = r.bowType || 'recurve';
        document.getElementById('coach-comment').value = r.comment || ''; document.getElementById('round-label-display').innerText = `Round ${currentRoundIdx+1}`;
        const prev = document.getElementById('photo-preview'); const cont = document.getElementById('photo-preview-container');
        if(r.targetPhoto) { prev.src=r.targetPhoto; cont.style.display='block'; } else { prev.src=""; cont.style.display='none'; }
        initScoreTable(false); updateSigUI('archer', r.archerSigned); updateSigUI('coach', r.coachSigned);
    }

    let scores=[]; let currentFocus={r:0,c:0};
    function initScoreTable(reset) {
        const mode = document.getElementById('mode-select').value; const rows = (mode==='outdoor')?6:10; const arrows = (mode==='outdoor')?6:3;
        if(reset || !currentRoundData.scores) scores = Array(rows).fill().map(()=>Array(arrows).fill(null)); else scores = currentRoundData.scores;
        currentRoundData.mode = mode; // æ›´æ–°æ¨¡å¼
        
        const thead = document.getElementById('table-head-row'); let h = '<th width="15%">è¶Ÿ</th>'; for(let i=1; i<=arrows; i++) h += `<th>${i}</th>`; h += '<th>è¨ˆ</th><th>ç¸½è¨ˆ</th>'; thead.innerHTML = h;

        const tbody = document.getElementById('table-body'); tbody.innerHTML = "";
        let cumulativeTotal = 0;
        
        for(let r=0; r<rows; r++) {
            let rowTotal = 0;
            const tr = document.createElement('tr');
            tr.innerHTML += `<td>${r+1}</td>`; // è¶Ÿæ•¸
            
            // åˆ†æ•¸æ¬„ä½
            for(let c=0; c<arrows; c++) {
                const s = scores[r][c];
                const scoreValue = (s==='X'||s==='10')?10:(s==='M'?0:parseInt(s)||0);
                rowTotal += scoreValue;
                cumulativeTotal += scoreValue;
                
                const td = document.createElement('td');
                const cell = document.createElement('div');
                cell.className = 'score-cell';
                cell.id = `score-cell-${r}-${c}`;
                cell.onclick = () => setFocus(r,c);
                cell.innerText = s!==null ? s : '';
                cell.classList.add(getScoreColor(s));
                
                td.appendChild(cell);
                tr.appendChild(td);
            }
            
            // è©²è¶Ÿç¸½è¨ˆ
            tr.innerHTML += `<td style="font-weight:bold; background:#f0f0f0;">${rowTotal}</td>`;
            // ç´¯è¨ˆç¸½è¨ˆ
            tr.innerHTML += `<td style="font-weight:bold; background:#e0e0e0;"><span id="cum-total-${r}">${cumulativeTotal}</span></td>`;
            tbody.appendChild(tr);
        }
        
        calculateTotal();
        // é‡è¨­ç„¦é»åˆ°ç¬¬ä¸€å€‹ç©ºä½
        setFocus(0,0, true);
    }
    
    function setFocus(r, c, findFirstEmpty = false) {
        document.querySelectorAll('.score-cell').forEach(cell => cell.classList.remove('active'));
        const rows = scores.length;
        const arrows = scores[0].length;
        
        let targetR = r;
        let targetC = c;

        if (findFirstEmpty) {
            let found = false;
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < arrows; j++) {
                    if (scores[i][j] === null || scores[i][j] === "") {
                        targetR = i;
                        targetC = j;
                        found = true;
                        break;
                    }
                }
                if (found) break;
            }
            if (!found) { // å¦‚æœå…¨æ»¿ï¼Œå‰‡ç§»å‹•åˆ°æœ€å¾Œä¸€æ ¼
                targetR = rows - 1;
                targetC = arrows - 1;
            }
        }
        
        currentFocus = {r:targetR, c:targetC};
        const activeCell = document.getElementById(`score-cell-${targetR}-${targetC}`);
        if(activeCell) {
            activeCell.classList.add('active');
            // è‡ªå‹•æ²å‹•åˆ°ç„¦é»
            const container = document.querySelector('#view-score .scroll-content');
            if(container) {
                const cellRect = activeCell.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                if (cellRect.bottom > containerRect.bottom || cellRect.top < containerRect.top) {
                    container.scrollTo({
                        top: container.scrollTop + cellRect.top - containerRect.top - (containerRect.height / 3),
                        behavior: 'smooth'
                    });
                }
            }
        }
    }
    
    function getScoreColor(s) {
        const v = (s==='X')?10:parseInt(s);
        if(v>=9) return 'bg-yellow';
        if(v>=7) return 'bg-red';
        if(v>=5) return 'bg-blue';
        if(v>=3) return 'bg-black';
        if(v>=1) return 'bg-white';
        return '';
    }

    function calculateTotal() {
        let grandTotal = 0;
        let XCount = 0;
        let TenPlusXCount = 0;
        const rows = scores.length;
        const arrows = scores[0].length;
        
        for(let r=0; r<rows; r++) {
            let rowTotal = 0;
            for(let c=0; c<arrows; c++) {
                const s = scores[r][c];
                const scoreValue = (s==='X'||s==='10')?10:(s==='M'?0:parseInt(s)||0);
                rowTotal += scoreValue;
                grandTotal += scoreValue;
                
                if(s==='X') { XCount++; TenPlusXCount++; }
                else if(s==='10') { TenPlusXCount++; }
            }
            
            // æ›´æ–° UI çš„è©²è¶Ÿç¸½è¨ˆå’Œç´¯è¨ˆç¸½è¨ˆ
            const cells = document.getElementById(`score-cell-${r}-0`).parentElement.parentElement.children;
            cells[arrows+1].innerText = rowTotal;
            cells[arrows+2].children[0].innerText = grandTotal;
        }

        document.getElementById('grand-total').innerText = grandTotal;
        document.getElementById('stats-display').innerText = `10+X: ${TenPlusXCount} | X: ${XCount}`;
        
        currentRoundData.total = grandTotal;
        currentRoundData.scores = scores;
        
        // æ›´æ–° Round Selector ä¸Šçš„ç¸½åˆ†
        const sel = document.getElementById('round-selector');
        sel.options[currentRoundIdx].text = `R${currentRoundIdx+1} (${grandTotal})`;
    }

    function inputScore(score) {
        const {r,c} = currentFocus;
        if(r >= scores.length || c >= scores[0].length) return; // è¶…å‡ºç¯„åœ
        
        scores[r][c] = score.toString();
        const cell = document.getElementById(`score-cell-${r}-${c}`);
        cell.innerText = scores[r][c];
        cell.className = 'score-cell'; // é‡ç½®
        cell.classList.add(getScoreColor(scores[r][c]));

        calculateTotal();
        moveFocus(1); // è‡ªå‹•ç§»å‹•åˆ°ä¸‹ä¸€æ ¼
        triggerAutoSave();
    }
    
    function deleteScore() {
        const {r,c} = currentFocus;
        if(r < 0 || c < 0) { // å¦‚æœåœ¨ç¬¬ä¸€æ ¼ä¹‹å‰
            setFocus(0,0);
            return;
        }

        if(scores[r][c] !== null && scores[r][c] !== "") { // å¦‚æœç•¶å‰æ ¼æœ‰å€¼ï¼Œå…ˆæ¸…ç©ºç•¶å‰æ ¼
            scores[r][c] = null;
            const cell = document.getElementById(`score-cell-${r}-${c}`);
            cell.innerText = '';
            cell.className = 'score-cell';
            setFocus(r,c);
        } else { // å¦‚æœç•¶å‰æ ¼ç‚ºç©ºï¼Œå‰‡ç§»å‹•åˆ°å‰ä¸€æ ¼æ¸…ç©º
            moveFocus(-1);
            const newR = currentFocus.r;
            const newC = currentFocus.c;
            if(newR >= 0 && newC >= 0) {
                scores[newR][newC] = null;
                const cell = document.getElementById(`score-cell-${newR}-${newC}`);
                cell.innerText = '';
                cell.className = 'score-cell';
            }
        }
        calculateTotal();
        triggerAutoSave();
    }
    
    function moveFocus(dir) {
        let {r,c} = currentFocus;
        const rows = scores.length;
        const arrows = scores[0].length;
        
        let newC = c + dir;
        let newR = r;
        
        if (newC >= arrows) {
            newC = 0;
            newR = r + 1;
        } else if (newC < 0) {
            newC = arrows - 1;
            newR = r - 1;
        }
        
        if (newR < 0) newR = 0;
        if (newR >= rows) newR = rows - 1;

        setFocus(newR, newC);
    }
    
    // --- ç°½åå’Œåœ–ç‰‡é‚è¼¯ ---
    function updateSigUI(type, signed) {
        const el = document.getElementById(`sig-${type}`);
        if(signed) {
            el.innerText = `âœ… ${type==='archer'?'å°„æ‰‹':'æ•™ç·´'}å·²ç°½ç½²`;
            el.style.fontWeight = 'bold';
            el.style.color = 'green';
        } else {
            el.innerText = `${type==='archer'?'å°„æ‰‹ç°½åˆ°':'æ•™ç·´ç°½ç½²'}`;
            el.style.fontWeight = 'normal';
            el.style.color = '#777';
        }
    }

    function handleSign(type) {
        if (type === 'coach' && currentRole === 'archer') return alert("åªæœ‰æ•™ç·´å¯ä»¥ç°½ç½²ï¼");
        if (type === 'archer' && currentRole === 'coach') return alert("åªæœ‰å°„æ‰‹å¯ä»¥ç°½ç½²ï¼");
        
        currentRoundData[`${type}Signed`] = !currentRoundData[`${type}Signed`];
        updateSigUI(type, currentRoundData[`${type}Signed`]);
        saveCurrentRound(true);
    }
    
    function handlePhotoUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        showLoading(true, "è™•ç†åœ–ç‰‡ä¸­...");

        const reader = new FileReader();
        reader.onload = (e) => {
            currentRoundData.targetPhoto = e.target.result;
            const prev = document.getElementById('photo-preview');
            prev.src = e.target.result;
            document.getElementById('photo-preview-container').style.display = 'block';
            showLoading(false);
            saveCurrentRound(true);
        };
        reader.readAsDataURL(file);
    }

    function deletePhoto() {
        if(confirm("ç¢ºå®šåˆªé™¤åœ–ç‰‡?")) {
            currentRoundData.targetPhoto = null;
            document.getElementById('photo-preview-container').style.display = 'none';
            document.getElementById('target-photo-input').value = null;
            saveCurrentRound(true);
        }
    }
    
    // --- å„²å­˜èˆ‡ PDF ---
    function saveCurrentRound(isSilent = false) {
        if(!currentRoundData) return;
        currentRoundData.scores = scores;
        currentRoundData.total = document.getElementById('grand-total').innerText;
        currentRoundData.comment = document.getElementById('coach-comment').value;
        currentRoundData.mode = document.getElementById('mode-select').value;
        currentRoundData.bowType = document.getElementById('bow-selector').value;
        
        localCacheData[selectedDate].rounds[currentRoundIdx] = currentRoundData;
        
        saveToCloud(() => {
            renderRoundSelector(localCacheData[selectedDate]);
            if (!isSilent) alert("å„²å­˜æˆåŠŸï¼");
        }, isSilent);
    }

    function toggleKeypad() {
        document.getElementById('keypad').classList.toggle('hidden-keypad');
    }

    function exportPDF() {
        // å…ˆå„²å­˜ä¸€æ¬¡ï¼Œç¢ºä¿æ•¸æ“šæœ€æ–°
        saveCurrentRound(true); 
        
        const element = document.getElementById('pdf-export-area');
        const filename = `${currentArcherName}_${selectedDate}_R${currentRoundIdx+1}_${currentRoundData.total}.pdf`;
        
        html2pdf().from(element).set({
            margin: 10,
            filename: filename,
            html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save();
    }

    // å•Ÿå‹•æ™‚è‡ªå‹•å˜—è©¦ç™»å…¥ï¼ˆç”¨æ–¼ä¿ç•™ç‹€æ…‹ï¼‰
    document.addEventListener('DOMContentLoaded', () => {
        // æª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„åå­—ï¼Œå¦‚æœæ²’æœ‰å‰‡åœç•™åœ¨é¦–é 
        const storedName = localStorage.getItem('lastArcherName');
        const storedAvatar = localStorage.getItem('lastArcherAvatar');
        if (storedName) {
            document.getElementById('archer-name-input').value = storedName;
            currentArcherAvatar = storedAvatar || 'ğŸ»';
            document.getElementById('current-avatar-btn').innerText = currentArcherAvatar;
        }
        
        // V35: åœ¨ DOMContentLoaded æ™‚åˆå§‹åŒ–éµç›¤ç‚ºéš±è—ï¼Œé¿å…é–ƒçˆ
        document.getElementById('keypad').classList.add('hidden-keypad');
    });

    // ç€è¦½å™¨é—œé–‰å‰å„²å­˜å°„æ‰‹ç‹€æ…‹
    window.addEventListener('beforeunload', () => {
        if (currentArcherName) {
            localStorage.setItem('lastArcherName', currentArcherName);
            localStorage.setItem('lastArcherAvatar', currentArcherAvatar);
        }
    });

</script>
</body>
</html>