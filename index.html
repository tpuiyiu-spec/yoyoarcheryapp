<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Yoyo æ•™ç·´çš„å°„ç®­è¨“ç·´ (V35 ä¿®å¾©ç‰ˆ)</title>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* --- å…¨å±€è®Šæ•¸ --- */
        :root {
            --primary-pink: #ffcbdb;
            --primary-blue: #a2d2ff;
            --primary-yellow: #fffdf5;
            --text-color: #5d4037;
            --stamp-red: #ff6b6b;
            --target-yellow: #ffe552;
            --target-red: #ff5252;
            --target-blue: #448aff;
            --target-black: #333333;
            --target-white: #ffffff;
            --font-main: 'Helvetica Rounded', Arial, sans-serif;
            --safe-top: env(safe-area-inset-top, 20px);
            --app-max-width: 600px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main);
            background-color: #f0f2f5;
            color: var(--text-color);
            margin: 0; padding: 0;
            display: flex; justify-content: center;
            height: 100dvh; /* å›ºå®šè¦–çª—é«˜åº¦ */
            overflow: hidden; /* å…§éƒ¨æ²å‹• */
        }

        .app-container {
            width: 100%;
            max-width: var(--app-max-width);
            background: #fff;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }

        .hidden { display: none !important; }

        /* --- é ‚éƒ¨ Header --- */
        .header {
            background: var(--primary-pink);
            min-height: 70px;
            padding-top: var(--safe-top);
            padding-left: 15px; padding-right: 15px; padding-bottom: 10px;
            display: flex; align-items: flex-end; justify-content: space-between;
            flex-shrink: 0; z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 1.2rem; margin: 0; color: white;
            text-shadow: 1px 1px 0 var(--text-color);
            margin-bottom: 5px;
        }
        .btn-header {
            background: rgba(255,255,255,0.95); border: none; color: var(--text-color);
            padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer;
            font-size: 0.95rem; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center;
        }

        /* --- å…§å®¹æ²å‹•å€ (é—œéµè¨­å®š) --- */
        .scroll-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 450px !important; /* é ç•™åº•éƒ¨ç©ºé–“ï¼Œé˜²æ­¢è¢«éµç›¤æ“‹ä½ */
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* --- ç™»å…¥é æ¨£å¼ --- */
        .login-area {
            background: white; padding: 25px; border-radius: 20px;
            margin: 20px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 2px solid #eee; text-align: center;
        }
        .login-input {
            width: 100%; padding: 15px; font-size: 1.2rem;
            border: 2px solid var(--primary-blue); border-radius: 15px;
            text-align: center; margin-bottom: 15px; outline: none;
        }
        .mascot-area {
            text-align: center; margin-top: 30px;
            font-size: 80px; animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .home-btn {
            display: block; width: 100%; padding: 15px;
            border-radius: 30px; border: 2px solid var(--text-color);
            font-size: 1.1rem; font-weight: bold; cursor: pointer;
            background: white; color: var(--text-color);
            box-shadow: 0 4px 0 #ddd; margin-bottom: 15px; transition: 0.1s;
        }
        .home-btn:active { transform: translateY(3px); box-shadow: none; }
        .btn-pink { background: var(--primary-pink); color: white; border: none; }
        .btn-blue { background: var(--primary-blue); color: white; border: none; }

        /* --- é ­åƒé¸æ“‡ --- */
        .avatar-circle {
            width: 80px; height: 80px; border-radius: 50%;
            background: white; border: 3px solid var(--primary-pink);
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; margin: 0 auto 15px auto; cursor: pointer;
            position: relative;
        }
        .avatar-circle::after {
            content: 'âœï¸'; position: absolute; bottom: 0; right: 0;
            font-size: 1rem; background: white; border-radius: 50%;
            border: 1px solid #ddd; padding: 2px;
        }

        /* --- åˆ—è¡¨èˆ‡å¡ç‰‡ --- */
        .student-list {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px; margin-top: 20px;
        }
        .student-card {
            background: white; border: 2px solid var(--primary-blue);
            border-radius: 15px; padding: 20px; text-align: center;
            cursor: pointer; box-shadow: 0 4px 0 #dbeafe;
        }
        .student-icon { font-size: 3rem; display: block; margin-bottom: 5px; }
        .student-name { font-weight: bold; font-size: 1.1rem; word-break: break-all; }

        .history-card {
            background: white; border: 1px solid #eee;
            border-left: 5px solid var(--primary-blue);
            border-radius: 10px; padding: 15px; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; cursor: pointer;
        }
        .history-header { display: flex; justify-content: space-between; width: 100%; }
        .history-info { flex: 1; }
        .h-date { font-size: 0.85rem; color: #888; margin-bottom: 3px; }
        .h-title { font-weight: bold; font-size: 1.1rem; }
        .h-stats { display: flex; gap: 10px; margin-top: 5px; flex-wrap: wrap; }
        .stat-badge { background: #f0f0f0; padding: 3px 8px; border-radius: 5px; font-size: 0.85rem; color: #555; }
        .h-comment { margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 5px; font-size: 0.9rem; color: #444; border-left: 3px solid #ccc; }
        
        .btn-delete-record {
            background: #ffebee; color: #c62828; border: 1px solid #ffcdd2;
            width: 35px; height: 35px; border-radius: 50%; font-size: 1rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            margin-left: 10px; flex-shrink: 0;
        }

        /* --- æœˆæ›† --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 10px; }
        .cal-day {
            aspect-ratio: 0.9; background: white; border: 1px solid #eee;
            border-radius: 8px; padding: 2px; position: relative; cursor: pointer;
        }
        .cal-day.today { border: 2px solid var(--primary-blue); background: #f0f8ff; }
        .cal-scores { font-size: 0.6rem; color: #666; display: flex; flex-direction: column; margin-top: 2px; }
        .stamp-mark { position: absolute; bottom: 1px; right: 1px; font-size: 16px; }

        /* --- è¨ˆåˆ†æ¿ --- */
        .pdf-area { background: white; padding: 10px; border-radius: 10px; border: 1px solid #eee; }
        
        .top-toolbar {
            background: #f5f5f5; height: 55px; padding: 0 10px;
            display: flex; align-items: center; gap: 10px;
            flex-shrink: 0; border-bottom: 1px solid #ddd; overflow-x: auto;
        }
        .btn-tool {
            background: white; border: 1px solid #ccc; padding: 5px 12px;
            border-radius: 20px; font-size: 0.85rem; font-weight: bold;
            cursor: pointer; white-space: nowrap;
        }
        .round-selector {
            padding: 6px; border-radius: 15px; border: 2px solid var(--primary-blue);
            font-weight: bold; font-size: 0.9rem;
        }
        .save-status { font-size: 0.75rem; color: #666; margin-left: auto; font-weight: bold; white-space: nowrap; }

        .score-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; background: white; border-radius: 8px; overflow: hidden; font-size: 0.9rem; }
        .score-table th { background: var(--primary-blue); color: white; padding: 8px 2px; }
        .score-table td { border: 1px solid #ddd; height: 42px; padding: 0; text-align: center; }
        .score-cell { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
        .score-cell.active { box-shadow: inset 0 0 0 3px var(--primary-pink); }
        
        .bg-yellow { background-color: var(--target-yellow); }
        .bg-red { background-color: var(--target-red); }
        .bg-blue { background-color: var(--target-blue); }
        .bg-black { background-color: var(--target-black); color: white !important; text-shadow: 0 0 2px black; }
        .bg-white { background-color: var(--target-white); }

        .summary-row { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin: 10px 0; }
        .stats-box { background: #e3f2fd; color: #1565c0; padding: 10px; border-radius: 10px; font-weight: bold; }
        .total-display { text-align: right; font-size: 1.3rem; font-weight: bold; background: var(--primary-pink); color: white; padding: 10px; border-radius: 10px; }

        /* --- ç°½åˆ°å€ (V35 é‡é»ä¿®å¾©) --- */
        .signature-area {
            display: flex; justify-content: space-around; margin-top: 20px;
            border: 2px dashed #bbb; /* åŠ æ·±é‚Šæ¡† */
            padding: 15px; border-radius: 15px; background: #fafafa;
        }
        .sig-box {
            text-align: center; width: 45%; cursor: pointer;
            background: white; border: 1px solid #ddd; border-radius: 10px; padding: 5px;
            transition: transform 0.1s;
        }
        .sig-box:active { transform: scale(0.95); background: #f0f0f0; }
        .sig-placeholder {
            height: 50px; border-bottom: 2px solid #ccc; margin-bottom: 5px;
            display: flex; align-items: flex-end; justify-content: center;
            color: #aaa; font-size: 0.9rem; font-weight: bold;
        }
        .stamp-img {
            border: 3px double var(--stamp-red); color: var(--stamp-red);
            font-weight: bold; padding: 5px 10px; transform: rotate(-8deg);
            font-family: 'Courier New', monospace; font-size: 1.1rem;
            display: inline-block; margin-bottom: 5px;
        }

        .comment-box { width: 100%; border: 1px solid #ddd; background: #fff; height: 60px; margin-top: 5px; padding: 5px; border-radius: 5px; }
        .photo-section { margin-top: 15px; padding: 10px; border: 2px dashed #ccc; border-radius: 10px; text-align: center; }
        .photo-preview { max-width: 100%; margin-top: 10px; border-radius: 8px; }
        .btn-camera { background: var(--primary-blue); color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }

        /* --- éµç›¤èˆ‡æŒ‰éˆ• --- */
        .keypad-container {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: var(--app-max-width);
            background: white; padding: 8px; padding-bottom: calc(8px + var(--safe-top));
            box-shadow: 0 -4px 15px rgba(0,0,0,0.15);
            z-index: 100; display: flex; flex-direction: column; gap: 5px;
            height: 260px; transition: transform 0.3s ease;
        }
        .keypad-container.hidden-keypad { transform: translate(-50%, 110%); }
        .key-row { display: flex; gap: 4px; height: 100%; max-height: 55px; }
        .key-btn { flex: 1; border: none; border-radius: 6px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
        .k-y { background: var(--target-yellow); } .k-r { background: var(--target-red); color: white; }
        .k-b { background: var(--target-blue); color: white; } .k-bk { background: var(--target-black); color: white; }
        .k-w { background: white; border: 1px solid #ccc; } .k-del { background: #ffcdd2; color: #d32f2f; flex: 1.5; }
        .k-nav { background: var(--primary-pink); color: white; font-size: 1rem; }

        .btn-back-to-top {
            position: fixed; bottom: 280px; right: 20px;
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(255, 203, 219, 0.95); color: white; border: 2px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-size: 1.5rem;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 150; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .btn-back-to-top.visible { opacity: 1; pointer-events: auto; }
        @media (min-width: 600px) { .btn-back-to-top { left: 50%; margin-left: 240px; right: auto; } }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; display: flex; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; text-align: center; width: 85%; max-width: 350px; }
        .emoji-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; max-height: 300px; overflow-y: auto; padding: 10px; }
        .emoji-btn { font-size: 2rem; cursor: pointer; padding: 5px; background: #f9f9f9; border-radius: 5px; }

        .loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column; font-weight: bold; color: var(--text-color); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-pink); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="app-container">
    <div id="loading" class="loading-overlay hidden"><div class="spinner"></div><div id="loading-text">é€£ç·šä¸­...</div></div>
    <div id="back-to-top" class="btn-back-to-top" onclick="scrollToTop()">â¬†ï¸</div>

    <div id="view-home">
        <div class="header"><h1>ğŸ¹ Yoyo å°„ç®­ (Cloud)</h1></div>
        <div class="scroll-content" style="text-align: center; padding-top: 30px;">
            <div class="mascot-area">ğŸ» ğŸ¯ ğŸ°</div>
            <p style="color:#888; font-weight:bold; color:var(--stamp-red);">è«‹è¼¸å…¥åå­—åŠé ­åƒï¼ˆéœ€æ¯æ¬¡éƒ½ç›¸åŒï¼‰</p>
            <div class="login-area">
                <div id="current-avatar-btn" class="avatar-circle" onclick="openEmojiSelector()">ğŸ»</div>
                <input type="text" id="archer-name-input" class="login-input" placeholder="è«‹è¼¸å…¥åå­—">
                <button class="home-btn btn-pink" onclick="loginArcher()">æˆ‘æ˜¯å°„æ‰‹ (ç™»å…¥)</button>
                <button class="home-btn btn-blue" onclick="openLogin()">æˆ‘æ˜¯æ•™ç·´ (ç®¡ç†)</button>
            </div>
        </div>
    </div>

    <div id="view-coach-dashboard" class="hidden">
        <div class="header">
            <button class="btn-header" onclick="navTo('view-home')">ç™»å‡º</button>
            <h1>å­¸ç”Ÿåå–®</h1>
            <button class="btn-header" onclick="loadAllArchers()">ğŸ”„</button>
        </div>
        <div class="scroll-content">
            <div id="student-list-container" class="student-list"></div>
        </div>
    </div>

    <div id="view-student-history" class="hidden">
        <div class="header">
            <button class="btn-header" onclick="handleHistoryBack()">è¿”å›</button>
            <h1>æˆç¸¾ç¸½è¦½</h1>
            <div style="width: 50px;"></div>
        </div>
        <div class="scroll-content">
            <h3 id="history-archer-name" style="text-align: center;"></h3>
            <div id="history-list-container"></div>
            <button class="home-btn btn-blue" style="margin-top:20px;" onclick="navTo('view-calendar')">ğŸ“… è¡Œäº‹æ›† / æ–°ç´€éŒ„</button>
            <div style="margin-top:20px; text-align:center;">
                 <button class="btn-danger" style="background:#c62828; color:white; border:none; padding:10px; border-radius:10px;" onclick="clearAllRecords()">âš ï¸ æ¸…ç©ºç´€éŒ„</button>
            </div>
        </div>
    </div>

    <div id="view-calendar" class="hidden">
        <div class="header">
            <button class="btn-header" onclick="handleCalendarBack()">è¿”å›</button>
            <h1>è¡Œäº‹æ›†</h1>
            <div style="width: 50px;"></div>
        </div>
        <div class="scroll-content">
            <div style="display:flex; justify-content:space-between; padding: 10px;">
                <button onclick="changeMonth(-1)">â—€</button>
                <h2 id="month-display" style="margin:0;"></h2>
                <button onclick="changeMonth(1)">â–¶</button>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
    </div>

    <div id="view-score" class="hidden">
        <div class="header">
            <button class="btn-header" onclick="goBackFromScore()">è¿”å›</button>
            <h1>è¨ˆåˆ†æ¿</h1>
            <button class="btn-header" style="color:var(--stamp-red);" onclick="saveCurrentRound()">å„²å­˜</button>
        </div>
        <div class="top-toolbar">
            <select id="round-selector" class="round-selector" onchange="switchRound()"></select>
            <span id="save-status" class="save-status"></span>
            <button class="btn-tool" onclick="exportPDF()">ğŸ“„ PDF</button>
            <button class="btn-tool" onclick="toggleKeypad()">éµç›¤</button>
        </div>
        
        <div class="scroll-content">
            <div id="pdf-export-area" class="pdf-area">
                <div class="controls-info" style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span id="date-label" style="font-weight:bold;"></span>
                    <span id="pdf-archer-name" style="color:#555;"></span>
                </div>
                <div class="controls-info" style="margin-top:5px; border-bottom: 2px dashed #eee; padding-bottom:5px;">
                     <div style="display:flex; gap:5px; align-items:center;">
                         <select id="bow-selector" onchange="triggerAutoSave()" style="padding:4px; border-radius:5px; border:1px solid #ccc; font-size:0.9rem;">
                            <option value="recurve">åæ›²å¼“</option>
                            <option value="compound">è¤‡åˆå¼“</option>
                         </select>
                         <select id="mode-select" onchange="initScoreTable()" style="padding:4px; border-radius:5px; border:1px solid #ccc; font-size:0.9rem;">
                            <option value="outdoor">å®¤å¤– (36ç®­)</option>
                            <option value="indoor">å®¤å…§ (30ç®­)</option>
                        </select>
                     </div>
                     <span id="round-label-display" style="color:var(--stamp-red); font-weight:bold;">Round 1</span>
                </div>

                <table class="score-table">
                    <thead><tr id="table-head-row"></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>

                <div class="summary-row">
                    <div class="stats-box" id="stats-display">10+X: 0 | X: 0</div>
                    <div class="total-display">ç¸½åˆ†: <span id="grand-total">0</span></div>
                </div>

                <div class="signature-area">
                    <div class="sig-box" onclick="handleSign('archer')">
                        <div id="sig-archer" class="sig-placeholder">å°„æ‰‹ç°½åˆ°</div>
                        <small>(é»æ“Š)</small>
                    </div>
                    <div class="sig-box" onclick="handleSign('coach')">
                        <div id="sig-coach" class="sig-placeholder">æ•™ç·´ç°½ç½²</div>
                        <small>(éœ€ç™»å…¥)</small>
                    </div>
                </div>
                
                <div style="margin-top:15px;">
                    <label>ğŸ“‹ è©•èªï¼š</label>
                    <textarea id="coach-comment" class="comment-box" placeholder="è«‹è¼¸å…¥..."></textarea>
                </div>

                <div class="photo-section">
                    <button class="btn-camera" onclick="document.getElementById('target-photo-input').click()">ğŸ“· æ‹æ”/ä¸Šå‚³é¶é¢</button>
                    <input type="file" id="target-photo-input" accept="image/*" style="display:none;" onchange="handlePhotoUpload(event)">
                    <div id="photo-preview-container" style="display:none; margin-top:10px;">
                        <img id="photo-preview" class="photo-preview" src="">
                        <button onclick="deletePhoto()" style="color:red; margin-top:5px;">åˆªé™¤ç…§ç‰‡</button>
                    </div>
                </div>
                <div style="text-align:center; margin-top:20px; color:#ccc; font-size:0.7rem;">Generated by Yoyo Archery App</div>
            </div>
        </div>
        
        <div class="keypad-container" id="keypad">
            <div class="key-row"><button class="key-btn k-y" onclick="inputScore('X')">X</button><button class="key-btn k-y" onclick="inputScore(10)">10</button><button class="key-btn k-y" onclick="inputScore(9)">9</button></div>
            <div class="key-row"><button class="key-btn k-r" onclick="inputScore(8)">8</button><button class="key-btn k-r" onclick="inputScore(7)">7</button><button class="key-btn k-b" onclick="inputScore(6)">6</button><button class="key-btn k-b" onclick="inputScore(5)">5</button></div>
            <div class="key-row"><button class="key-btn k-bk" onclick="inputScore(4)">4</button><button class="key-btn k-bk" onclick="inputScore(3)">3</button><button class="key-btn k-w" onclick="inputScore(2)">2</button><button class="key-btn k-w" onclick="inputScore(1)">1</button></div>
            <div class="key-row"><button class="key-btn k-w" onclick="inputScore('M')">M</button><button class="key-btn k-del" onclick="deleteScore()">â¬…</button><button class="key-btn k-nav" onclick="moveFocus(1)">ä¸‹ä¸€æ ¼</button></div>
        </div>
    </div>

    <div id="emoji-modal" class="hidden modal-overlay"><div class="modal-box"><h3>é¸æ“‡é ­åƒ</h3><div class="emoji-grid" id="emoji-grid"></div><button style="margin-top:15px;" onclick="closeEmojiSelector()">å–æ¶ˆ</button></div></div>
    <div id="login-modal" class="hidden modal-overlay"><div class="modal-box"><h3>æ•™ç·´ç™»å…¥</h3><input type="password" id="coach-pwd" class="login-input" placeholder="å¯†ç¢¼"><button class="home-btn btn-blue" onclick="checkLogin()">ç™»å…¥</button><button onclick="closeLogin()">å–æ¶ˆ</button></div></div>

</div>

<script>
    // --- 1. FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBfy1pe_3WIigOpZXXI3kASKqhxEsHWGO8",
        authDomain: "yoyo-archery-app.firebaseapp.com",
        projectId: "yoyo-archery-app",
        storageBucket: "yoyo-archery-app.firebasestorage.app",
        messagingSenderId: "540788690338",
        appId: "1:540788690338:web:6bed490f095102a8baf6fb",
        measurementId: "G-99R8BXR4L2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 2. é‚è¼¯ ---
    let currentRole='archer', currentArcherName='', currentArcherAvatar='ğŸ»';
    let selectedDate = new Date().toISOString().split('T')[0];
    let displayMonth = new Date();
    let currentRoundData={}, currentRoundIdx=0, localCacheData={};
    let lastView = 'view-home'; let autoSaveTimer = null; 

    function setupScrollListener() { const els = document.querySelectorAll('.scroll-content'); const btn = document.getElementById('back-to-top'); els.forEach(el => { el.onscroll = function() { if (!el.parentElement.classList.contains('hidden') && el.scrollTop > 300) btn.classList.add('visible'); else btn.classList.remove('visible'); }; }); }
    function scrollToTop() { const v = document.querySelector('.app-container > div:not(.hidden) .scroll-content'); if(v) v.scrollTo({ top: 0, behavior: 'smooth' }); }
    setupScrollListener();

    function showLoading(show, msg="é€£ç·šä¸­...") { 
        const el=document.getElementById('loading'); 
        document.getElementById('loading-text').innerText = msg;
        if(show) el.classList.remove('hidden'); else el.classList.add('hidden'); 
    }
    function loadCloudData(name, cb) {
        showLoading(true, `è®€å– ${name}...`);
        db.collection("records").doc(name).get().then((doc) => {
            if (doc.exists) { const d=doc.data(); localCacheData = d.appData ? JSON.parse(d.appData) : {}; } 
            else { localCacheData = {}; }
            showLoading(false); if(cb) cb();
        }).catch(e => { showLoading(false); alert("è®€å–å¤±æ•—: " + e.message); });
    }
    function saveToCloud(cb, isSilent=false) {
        if(!currentArcherName) return;
        if(!isSilent) showLoading(true, "å„²å­˜ä¸­...");
        else document.getElementById('save-status').innerText = "â³...";
        
        db.collection("records").doc(currentArcherName).set({
            avatar: currentArcherAvatar,
            appData: JSON.stringify(localCacheData),
            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            if(!isSilent) showLoading(false);
            if(isSilent) {
                const t = new Date().toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
                document.getElementById('save-status').innerText = "âœ… " + t;
            }
            if(cb) cb();
        }).catch(e => {
            if(!isSilent) { showLoading(false); alert("å„²å­˜å¤±æ•—"); }
            else document.getElementById('save-status').innerText = "âŒ";
        });
    }
    function triggerAutoSave() {
        document.getElementById('save-status').innerText = "ğŸ“...";
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => saveCurrentRound(true), 1000);
    }

    // --- UI ---
    const avatars = ['ğŸ»','ğŸ°','ğŸ±','ğŸ¶','ğŸ¦','ğŸ¯','ğŸ¼','ğŸ¨','ğŸ·','ğŸ¸','ğŸ¹','ğŸ¯'];
    function openEmojiSelector() { 
        const g=document.getElementById('emoji-grid'); g.innerHTML="";
        avatars.forEach(e => { const b=document.createElement('div'); b.className='emoji-btn'; b.innerText=e; b.onclick=()=>selectAvatar(e); g.appendChild(b); });
        document.getElementById('emoji-modal').classList.remove('hidden');
    }
    function closeEmojiSelector() { document.getElementById('emoji-modal').classList.add('hidden'); }
    function selectAvatar(e) { currentArcherAvatar=e; document.getElementById('current-avatar-btn').innerText=e; closeEmojiSelector(); }

    function navTo(id, role) {
        if(role) currentRole = role;
        document.querySelectorAll('.app-container > div').forEach(d => { if(!d.classList.contains('loading-overlay') && d.id!=='back-to-top') d.classList.add('hidden'); });
        document.getElementById(id).classList.remove('hidden');
        if(id==='view-calendar') renderCalendar();
        if(id==='view-score') document.getElementById('keypad').classList.remove('hidden-keypad');
        
        const color = currentRole === 'coach' ? 'var(--primary-blue)' : 'var(--primary-pink)';
        document.querySelectorAll('.header').forEach(h => h.style.background = color);
        document.getElementById('back-to-top').classList.remove('visible');
    }

    function loginArcher() {
        const n = document.getElementById('archer-name-input').value.trim();
        if(!n) return alert("è«‹è¼¸å…¥åå­—");
        currentArcherName = n;
        updateLabels();
        loadCloudData(n, () => { renderHistory(n, currentArcherAvatar); navTo('view-student-history', 'archer'); });
    }

    function openLogin() { document.getElementById('login-modal').classList.remove('hidden'); }
    function closeLogin() { document.getElementById('login-modal').classList.add('hidden'); }
    function checkLogin() {
        if(document.getElementById('coach-pwd').value === '7201440') {
            closeLogin(); navTo('view-coach-dashboard', 'coach'); loadAllArchers();
        } else alert("å¯†ç¢¼éŒ¯èª¤");
    }
    
    function loadAllArchers() {
        showLoading(true);
        db.collection("records").get().then(snap => {
            const c = document.getElementById('student-list-container'); c.innerHTML="";
            snap.forEach(doc => {
                const n = doc.id; const d = doc.data(); const a = d.avatar || 'ğŸ»';
                const div = document.createElement('div'); div.className='student-card';
                div.innerHTML = `<span class="student-icon">${a}</span><div class="student-name">${n}</div>`;
                div.onclick = () => { currentArcherName=n; currentArcherAvatar=a; updateLabels(); loadCloudData(n, () => { renderHistory(n, a); navTo('view-student-history', 'coach'); }); };
                c.appendChild(div);
            });
            showLoading(false);
        }).catch(e => { showLoading(false); alert("è®€å–åå–®å¤±æ•—: " + e.message); });
    }

    function updateLabels() { document.getElementById('pdf-archer-name').innerText = `å°„æ‰‹: ${currentArcherAvatar} ${currentArcherName}`; }
    function handleHistoryBack() { navTo(currentRole==='coach' ? 'view-coach-dashboard' : 'view-home'); }
    function handleCalendarBack() { navTo('view-student-history'); }
    function goBackFromScore() { navTo('view-calendar'); }

    function renderHistory(n, a) {
        document.getElementById('history-archer-name').innerText = `${a} ${n} çš„ç´€éŒ„`;
        const c = document.getElementById('history-list-container'); c.innerHTML="";
        const list = [];
        Object.keys(localCacheData).forEach(date => { const d = localCacheData[date]; if(d.rounds) d.rounds.forEach((r, i) => list.push({date, idx: i, data: r})); });
        list.sort((x,y) => new Date(y.date) - new Date(x.date));
        if(list.length===0) c.innerHTML="<p style='text-align:center;color:#999'>ç„¡ç´€éŒ„</p>";
        list.forEach(item => {
            const r = item.data;
            let arrowCnt = 0; if(r.scores) r.scores.forEach(row => row.forEach(v => { if(v!==null && v!=="") arrowCnt++; }));
            const tot = parseInt(r.total)||0;
            const avg = arrowCnt>0 ? (tot/arrowCnt).toFixed(1) : "0.0";
            const modeT = r.mode==='indoor'?'å®¤å…§':'å®¤å¤–'; const bowT = r.bowType==='compound'?'è¤‡åˆå¼“':'åæ›²å¼“';
            let comm = r.comment ? `<div class="h-comment">ğŸ’¬ ${r.comment}</div>` : '';
            const div = document.createElement('div'); div.className='history-card';
            div.innerHTML = `<div class="history-header" onclick="openScore('${item.date}', ${item.idx})"><div class="history-info"><div class="h-date">${item.date} â€¢ R${item.idx+1} (${bowT})</div><div class="h-title">${modeT} (${arrowCnt}ç®­)</div><div class="h-stats"><span class="stat-badge">ç¸½åˆ†:${tot}</span><span class="stat-badge stat-avg">å‡:${avg}</span>${r.coachSigned?' <span class="stat-badge" style="color:red">ğŸ’®å·²ç°½</span>':''}</div></div><button class="btn-delete-record" onclick="deleteRound('${item.date}', ${item.idx}, event)">ğŸ—‘ï¸</button></div>${comm}`;
            c.appendChild(div);
        });
    }
    function deleteRound(d, i, e) { e.stopPropagation(); if(!confirm("åˆªé™¤?")) return; let dd = localCacheData[d]; dd.rounds.splice(i, 1); if(dd.rounds.length===0) delete localCacheData[d]; saveToCloud(() => renderHistory(currentArcherName, currentArcherAvatar)); }
    function clearAllRecords() { if(confirm("æ¸…ç©ºæ‰€æœ‰?")) { localCacheData={}; saveToCloud(() => renderHistory(currentArcherName, currentArcherAvatar)); } }

    function renderCalendar() { const g=document.getElementById('calendar-grid'); g.innerHTML=""; const y=displayMonth.getFullYear(); const m=displayMonth.getMonth(); document.getElementById('month-display').innerText = `${y}å¹´ ${m+1}æœˆ`; const dim = new Date(y, m+1, 0).getDate(); const first = new Date(y, m, 1).getDay(); for(let i=0; i<first; i++) g.appendChild(document.createElement('div')); for(let d=1; d<=dim; d++) { const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; const el = document.createElement('div'); el.className='cal-day'; el.innerHTML = `<div style="font-size:0.8rem;font-weight:bold;">${d}</div>`; if(ds===new Date().toISOString().split('T')[0]) el.style.border="2px solid var(--primary-blue)"; const dd = localCacheData[ds]; if(dd && dd.rounds && dd.rounds.length>0) { el.style.background='#fffbe6'; const sl = document.createElement('div'); sl.className='cal-scores'; dd.rounds.forEach((r, i) => { if(i<2) sl.innerHTML += `<div>R${i+1}: ${r.total}</div>`; }); el.appendChild(sl); } el.onclick = () => openScore(ds); g.appendChild(el); } }
    function changeMonth(d) { displayMonth.setMonth(displayMonth.getMonth()+d); renderCalendar(); }

    function openScore(dateStr, idx=null) {
        selectedDate = dateStr; document.getElementById('date-label').innerText = dateStr; document.getElementById('save-status').innerText = "";
        let dd = localCacheData[dateStr]; if(!dd || !dd.rounds) dd = { rounds: [] };
        if(dd.rounds.length === 0) createNewRound(dd);
        currentRoundIdx = (idx!==null) ? idx : dd.rounds.length-1; localCacheData[dateStr] = dd;
        renderRoundSelector(dd); loadRound(dd.rounds[currentRoundIdx]);
        document.getElementById('coach-comment').readOnly = (currentRole==='archer');
        navTo('view-score');
    }
    function createNewRound(dd) { dd.rounds.push({mode:'outdoor', bowType:'recurve', scores:null, total:0, comment:'', archerSigned:false, coachSigned:false, targetPhoto:null}); return dd.rounds.length-1; }
    function renderRoundSelector(dd) { const s = document.getElementById('round-selector'); s.innerHTML=""; dd.rounds.forEach((r, i) => { const o=document.createElement('option'); o.value=i; o.text=`R${i+1} (${r.total})`; s.appendChild(o); }); const add = document.createElement('option'); add.value="new"; add.text="â•"; s.appendChild(add); s.value = currentRoundIdx; }
    function switchRound() { const v = document.getElementById('round-selector').value; saveCurrentRound(true); let dd = localCacheData[selectedDate]; if(v==='new') { if(confirm("æ–°ä¸€è¼ª?")) { currentRoundIdx=createNewRound(dd); renderRoundSelector(dd); loadRound(dd.rounds[currentRoundIdx]); } else document.getElementById('round-selector').value = currentRoundIdx; } else { currentRoundIdx = parseInt(v); loadRound(dd.rounds[currentRoundIdx]); } }
    function loadRound(r) {
        currentRoundData = r;
        document.getElementById('mode-select').value = r.mode || 'outdoor'; document.getElementById('bow-selector').value = r.bowType || 'recurve';
        document.getElementById('coach-comment').value = r.comment || ''; document.getElementById('round-label-display').innerText = `Round ${currentRoundIdx+1}`;
        const prev = document.getElementById('photo-preview'); const cont = document.getElementById('photo-preview-container');
        if(r.targetPhoto) { prev.src=r.targetPhoto; cont.style.display='block'; } else { prev.src=""; cont.style.display='none'; }
        initScoreTable(false); updateSigUI('archer', r.archerSigned); updateSigUI('coach', r.coachSigned);
    }

    let scores=[]; let currentFocus={r:0,c:0};
    function initScoreTable(reset) {
        const mode = document.getElementById('mode-select').value; const rows = (mode==='outdoor')?6:10; const arrows = (mode==='outdoor')?6:3;
        if(reset || !currentRoundData.scores) scores = Array(rows).fill().map(()=>Array(arrows).fill(null)); else scores = currentRoundData.scores;
        const thead = document.getElementById('table-head-row'); let h = '<th width="15%">è¶Ÿ</th>'; for(let i=1; i<=arrows; i++) h+=`<th>${i}</th>`; h+='<th>å°è¨ˆ</th>'; thead.innerHTML=h;
        const tbody = document.getElementById('table-body'); tbody.innerHTML="";
        for(let r=0; r<rows; r++) { const tr = document.createElement('tr'); tr.innerHTML = `<td style="background:#f0f8ff;font-weight:bold;">${r+1}</td>`; for(let c=0; c<arrows; c++) tr.innerHTML+=`<td><div id="cell-${r}-${c}" class="score-cell" onclick="setFocus(${r},${c})"></div></td>`; tr.innerHTML+=`<td id="sub-${r}" style="font-weight:bold;color:#555;">0</td>`; tbody.appendChild(tr); }
        refreshTableUI(); setFocus(0,0);
    }
    function refreshTableUI() {
        let grand=0; let c10=0, cX=0, c9=0; const mode = document.getElementById('mode-select').value;
        scores.forEach((row, r) => {
            let sub=0; row.forEach((v, c) => {
                const cell = document.getElementById(`cell-${r}-${c}`); if(cell) { cell.innerText = v===null?'':v; applyColor(cell, v); }
                let val=0; if(v==='X') { val=10; cX++; } else if(v==='M') val=0; else if(v!==null) { val=parseInt(v); if(val===10) c10++; if(val===9) c9++; } sub += val;
            }); document.getElementById(`sub-${r}`).innerText = sub; grand += sub;
        });
        document.getElementById('grand-total').innerText = grand;
        const sbox = document.getElementById('stats-display');
        if(mode==='outdoor') sbox.innerHTML = `10+X: ${c10+cX} | X: ${cX}`; else sbox.innerHTML = `10: ${c10+cX} | 9: ${c9}`;
    }
    function applyColor(el,v) { el.className="score-cell active"; if(v==='X'||v==10||v==9)el.classList.add('bg-yellow'); else if(v==8||v==7)el.classList.add('bg-red'); else if(v==6||v==5)el.classList.add('bg-blue'); else if(v==4||v==3)el.classList.add('bg-black'); else el.classList.add('bg-white'); }

    function setFocus(r,c) { const old = document.querySelector('.score-cell.active'); if(old) old.classList.remove('active'); currentFocus={r,c}; document.getElementById(`cell-${r}-${c}`).classList.add('active'); document.getElementById('keypad').classList.remove('hidden-keypad'); }
    function moveFocus(s) { const rows=scores.length; const cols=scores[0].length; let {r,c} = currentFocus; c+=s; if(c>=cols) { c=0; r++; } if(c<0) { c=cols-1; r--; } if(r>=0 && r<rows) setFocus(r,c); }
    function inputScore(v) { if(scores[currentFocus.r]) { scores[currentFocus.r][currentFocus.c]=v; refreshTableUI(); moveFocus(1); triggerAutoSave(); } }
    function deleteScore() { scores[currentFocus.r][currentFocus.c]=null; refreshTableUI(); triggerAutoSave(); }
    function toggleKeypad() { document.getElementById('keypad').classList.toggle('hidden-keypad'); }

    function handleSign(role) {
        if(currentRole!==role) return alert("æ¬Šé™ä¸è¶³");
        const div = document.getElementById(`sig-${role}`);
        const isSigned = div.innerHTML.includes('stamp-img');
        updateSigUI(role, !isSigned);
        triggerAutoSave();
    }
    function updateSigUI(role, signed) {
        const div = document.getElementById(`sig-${role}`);
        if(signed) { div.innerHTML = `<div class="stamp-img">${role==='archer'?'å·²ç°½':'èªè­‰'}</div>`; div.style.borderBottom="none"; }
        else { div.innerHTML = role==='archer'?'é»æ“Šç°½åˆ°':'é»æ“Šç°½ç½²'; div.style.borderBottom="2px solid #ccc"; }
    }

    function saveCurrentRound(silent=false) {
        currentRoundData.scores = scores; currentRoundData.total = document.getElementById('grand-total').innerText;
        currentRoundData.comment = document.getElementById('coach-comment').value; currentRoundData.mode = document.getElementById('mode-select').value;
        currentRoundData.bowType = document.getElementById('bow-selector').value;
        currentRoundData.archerSigned = document.getElementById('sig-archer').innerHTML.includes('stamp-img');
        currentRoundData.coachSigned = document.getElementById('sig-coach').innerHTML.includes('stamp-img');
        if(!localCacheData[selectedDate]) localCacheData[selectedDate] = { rounds: [] };
        localCacheData[selectedDate].rounds[currentRoundIdx] = currentRoundData; renderRoundSelector(localCacheData[selectedDate]); saveToCloud(null, silent);
    }

    function handlePhotoUpload(e) {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = function(ex) {
            const img = new Image();
            img.onload = function() {
                const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                const maxW = 600; let w=img.width; let h=img.height; if(w>maxW) { h*=maxW/w; w=maxW; }
                cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h);
                const d = cvs.toDataURL('image/jpeg', 0.6);
                currentRoundData.targetPhoto = d; document.getElementById('photo-preview').src = d; document.getElementById('photo-preview-container').style.display = 'block'; triggerAutoSave();
            }; img.src = ex.target.result;
        }; r.readAsDataURL(f);
    }
    function deletePhoto() { if(confirm("åˆªé™¤ç…§ç‰‡?")) { currentRoundData.targetPhoto=null; document.getElementById('photo-preview').src=""; document.getElementById('photo-preview-container').style.display='none'; triggerAutoSave(); } }
    
    function exportPDF() {
        document.getElementById('keypad').classList.add('hidden-keypad');
        const el = document.getElementById('pdf-export-area');
        const opt = { margin: 0.2, filename: `å°„ç®­_${selectedDate}_R${currentRoundIdx+1}.pdf`, image: {type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'a4'} };
        html2pdf().set(opt).from(el).save();
    }
</script>
</body>
</html>