<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Yoyo æ•™ç·´çš„å°„ç®­è¨“ç·´ (V18 å½±åƒç‰ˆ)</title>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* --- å…¨å±€è®Šæ•¸ --- */
        :root {
            --primary-pink: #ffcbdb; --primary-blue: #a2d2ff; --primary-yellow: #fffdf5;
            --text-color: #5d4037; --stamp-red: #ff6b6b;
            --target-yellow: #ffe552; --target-red: #ff5252; --target-blue: #448aff;
            --target-black: #333333; --target-white: #ffffff;
            --font-main: 'Helvetica Rounded', Arial, sans-serif;
            --safe-top: env(safe-area-inset-top, 20px);
            --header-height: calc(60px + var(--safe-top)); 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main); background-color: var(--primary-yellow);
            color: var(--text-color); margin: 0; padding: 0;
            display: flex; justify-content: center; height: 100vh; overflow: hidden;
        }
        .app-container {
            width: 100%; max-width: 800px; background: #fff; height: 100%;
            display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }
        .hidden { display: none !important; }

        /* --- Header --- */
        .header {
            background: var(--primary-pink); 
            height: var(--header-height); min-height: 80px; 
            padding-top: var(--safe-top); padding-left: 15px; padding-right: 15px; padding-bottom: 10px;
            display: flex; align-items: flex-end; justify-content: space-between;
            flex-shrink: 0; z-index: 20; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 1.2rem; margin: 0; color: white; text-shadow: 1px 1px 0 var(--text-color); margin-bottom: 5px; }
        .btn-header {
            background: rgba(255,255,255,0.95); border: none; color: var(--text-color);
            padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer;
            font-size: 0.95rem; box-shadow: 0 2px 4px rgba(0,0,0,0.15); 
            display: flex; align-items: center; justify-content: center;
        }

        .scroll-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 450px; -webkit-overflow-scrolling: touch; }

        /* --- ç…§ç‰‡ä¸Šå‚³å€æ¨£å¼ (V18 æ–°å¢) --- */
        .photo-section {
            margin-top: 15px; border: 2px dashed #ccc; border-radius: 10px;
            padding: 10px; text-align: center; background: #fafafa;
            position: relative;
        }
        .btn-camera {
            background: var(--primary-blue); color: white; border: none;
            padding: 8px 20px; border-radius: 20px; font-weight: bold;
            font-size: 0.9rem; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;
        }
        .photo-preview-container {
            margin-top: 10px; display: none; position: relative;
        }
        .photo-preview {
            max-width: 100%; max-height: 250px; border-radius: 8px;
            border: 2px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-delete-photo {
            position: absolute; top: -10px; right: -10px;
            background: var(--stamp-red); color: white; border: none;
            width: 30px; height: 30px; border-radius: 50%; font-weight: bold;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- æ­·å²æˆç¸¾åˆ—è¡¨ --- */
        .history-card {
            background: white; border: 1px solid #eee; border-left: 5px solid var(--primary-blue);
            border-radius: 10px; padding: 15px; margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .history-card:active { background: #f9f9f9; }
        .h-date { font-size: 0.85rem; color: #888; margin-bottom: 3px; }
        .h-title { font-weight: bold; font-size: 1.1rem; }
        .h-stats { display: flex; gap: 10px; margin-top: 5px; }
        .stat-badge { background: #f0f0f0; padding: 3px 8px; border-radius: 5px; font-size: 0.85rem; color: #555; }
        .stat-avg { background: var(--primary-pink); color: white; font-weight: bold; }
        .arrow-right { font-size: 1.5rem; color: #ccc; }

        /* --- å…¶ä»–æ¨£å¼ --- */
        .student-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 20px; }
        .student-card { background: white; border: 2px solid var(--primary-blue); border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 0 #dbeafe; }
        .student-card:active { transform: translateY(3px); box-shadow: none; }
        .student-icon { font-size: 3rem; margin-bottom: 5px; display: block; }
        .student-name { font-weight: bold; font-size: 1.1rem; color: var(--text-color); word-break: break-all;}

        .avatar-circle { width: 80px; height: 80px; border-radius: 50%; background: white; border: 3px solid var(--primary-pink); display: flex; align-items: center; justify-content: center; font-size: 3rem; margin: 0 auto 15px auto; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; }
        .avatar-circle::after { content: 'âœï¸'; position: absolute; bottom: 0; right: 0; font-size: 1rem; background: white; border-radius: 50%; border: 1px solid #ddd; padding: 2px; }
        .emoji-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 10px; max-height: 300px; overflow-y: auto; }
        .emoji-btn { font-size: 2rem; background: #f9f9f9; border: 1px solid #eee; border-radius: 10px; cursor: pointer; padding: 5px; }
        
        .top-toolbar { background: #f5f5f5; height: 55px; padding: 0 10px; display: flex; align-items: center; justify-content: center; gap: 10px; flex-shrink: 0; border-bottom: 1px solid #ddd; overflow-x: auto; }
        .btn-tool { background: white; border: 1px solid #ccc; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .round-selector { padding: 6px; border-radius: 15px; border: 2px solid var(--primary-blue); background: white; color: var(--text-color); font-weight: bold; font-size: 0.9rem; }
        
        .login-area { background: white; padding: 25px; border-radius: 20px; margin: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 2px solid #eee; }
        .login-input { width: 100%; padding: 15px; font-size: 1.2rem; border: 2px solid var(--primary-blue); border-radius: 15px; text-align: center; margin-bottom: 15px; outline: none; }
        
        .loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column; font-weight: bold; color: var(--text-color); }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-pink); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 10px; }
        .cal-day { aspect-ratio: 0.9; background: white; border: 1px solid #eee; border-radius: 8px; display: flex; flex-direction: column; padding: 2px; position: relative; cursor: pointer; overflow: hidden; }
        .cal-day.today { border: 2px solid var(--primary-blue); background: #f0f8ff; }
        .cal-scores { font-size: 0.65rem; color: #666; display: flex; flex-direction: column; margin-top: 2px; }
        .stamp-mark { position: absolute; font-size: 18px; bottom: 1px; right: 1px; opacity: 0.8; }

        .pdf-area { background: white; padding: 10px; border-radius: 10px; border: 1px solid #eee; }
        .score-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; background: white; border-radius: 8px; overflow: hidden; font-size: 0.9rem; }
        .score-table th { background: var(--primary-blue); color: white; padding: 8px 2px; }
        .score-table td { border: 1px solid #ddd; height: 42px; padding: 0; text-align: center; }
        .score-cell { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; color: black; cursor: pointer; }
        .score-cell.active { box-shadow: inset 0 0 0 3px var(--primary-pink); z-index: 5; }
        .bg-yellow { background-color: var(--target-yellow); } .bg-red { background-color: var(--target-red); } .bg-blue { background-color: var(--target-blue); } .bg-black { background-color: var(--target-black); color: white !important; text-shadow: 0 0 2px black; } .bg-white { background-color: var(--target-white); }
        .total-display { text-align: right; font-size: 1.2rem; font-weight: bold; background: var(--primary-pink); color: white; padding: 8px; border-radius: 8px; }
        .signature-area { display: flex; justify-content: space-around; margin-top: 20px; border: 2px dashed #ddd; padding: 10px; border-radius: 10px; }
        .sig-box { text-align: center; width: 45%; cursor: pointer; }
        .sig-placeholder { height: 40px; border-bottom: 2px solid #ccc; margin-bottom: 5px; display: flex; align-items: flex-end; justify-content: center; color: #ccc; font-size: 0.8rem; }
        .stamp-img { border: 3px double var(--stamp-red); color: var(--stamp-red); font-weight: bold; padding: 2px 8px; transform: rotate(-8deg); font-family: 'Courier New', monospace; font-size: 1rem; }
        .comment-box { width: 100%; border: 1px solid #ddd; background: #fff; height: 60px; margin-top: 5px; font-size: 1rem; padding: 5px; border-radius: 5px; }

        .keypad-container { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 8px; box-shadow: 0 -4px 15px rgba(0,0,0,0.15); z-index: 100; display: flex; flex-direction: column; gap: 5px; max-width: 800px; margin: 0 auto; height: 260px; transition: transform 0.3s ease; }
        .keypad-container.hidden-keypad { transform: translateY(110%); }
        .key-row { display: flex; gap: 4px; height: 100%; max-height: 55px; }
        .key-btn { flex: 1; border: none; border-radius: 6px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
        .key-btn:active { transform: translateY(2px); box-shadow: none; }
        .k-y { background: var(--target-yellow); } .k-r { background: var(--target-red); color: white; } .k-b { background: var(--target-blue); color: white; } .k-bk { background: var(--target-black); color: white; } .k-w { background: white; border: 1px solid #ccc; } .k-del { background: #ffcdd2; color: #d32f2f; flex: 1.5; } .k-nav { background: var(--primary-pink); color: white; font-size: 1rem; }

        .mascot-area { text-align: center; margin-top: 30px; font-size: 80px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .home-btn { display: block; width: 100%; padding: 15px; border-radius: 30px; border: 2px solid var(--text-color); font-size: 1.1rem; font-weight: bold; cursor: pointer; background: white; color: var(--text-color); box-shadow: 0 4px 0 #ddd; transition: 0.1s; }
        .home-btn:active { transform: translateY(3px); box-shadow: none; }
        .btn-pink { background: var(--primary-pink); color: white; border: none; }
        .btn-blue { background: var(--primary-blue); color: white; border: none; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; display: flex; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; text-align: center; width: 85%; max-width: 350px; }
    </style>
</head>
<body>

<div class="app-container">
    
    <div id="loading" class="loading-overlay hidden">
        <div class="spinner"></div>
        <div id="loading-text">é€£ç·šä¸­...</div>
    </div>

    <div id="view-home">
        <div class="header">
            <h1>ğŸ¹ Yoyo æ•™ç·´çš„å°„ç®­è¨“ç·´ (Cloud)</h1>
        </div>
        <div class="scroll-content" style="text-align: center; padding-top: 30px;">
            <div class="mascot-area">ğŸ» ğŸ¯ ğŸ°</div>
            <h2 style="margin-bottom: 5px;">æ­¡è¿å›ä¾†ï¼</h2>
            <p style="color:#888; margin-top:0;">è¨­å®šä½ çš„å°ˆå±¬é ­åƒ</p>
            <div class="login-area">
                <div id="current-avatar-btn" class="avatar-circle" onclick="openEmojiSelector()">ğŸ»</div>
                <input type="text" id="archer-name-input" class="login-input" placeholder="è«‹è¼¸å…¥åå­— (ä¾‹: å°å…«)">
                <button class="home-btn btn-pink" onclick="loginArcher()">æˆ‘æ˜¯å°„æ‰‹ (ç™»å…¥)</button>
                <div style="height:15px;"></div>
                <button class="home-btn btn-blue" onclick="openLogin()">æˆ‘æ˜¯æ•™ç·´ (ç®¡ç†)</button>
            </div>
        </div>
    </div>

    <div id="view-coach-dashboard" class="hidden">
        <div class="header">
            <button class="btn-header" onclick="navTo('view-home')">âŒ‚ ç™»å‡º</button>
            <h1>å­¸ç”Ÿåå–®</h1>
            <button class="btn-header" onclick="loadAllArchers()">ğŸ”„</button>
        </div>
        <div class="scroll-content">
            <p style="text-align:center; color:#666; font-size:0.9rem;">é»æ“Šå­¸ç”Ÿå¡ç‰‡æŸ¥çœ‹æˆç¸¾ç¸½è¦½</p>
            <div id="student-list-container" class="student-list"></div>
        </div>
    </div>

    <div id="view-student-history" class="hidden">
        <div class="header">
            <button class="btn-header" onclick="handleHistoryBack()">â¬… è¿”å›</button>
            <h1 id="history-title">æˆç¸¾ç¸½è¦½</h1>
            <div style="width: 60px;"></div>
        </div>
        <div class="scroll-content">
            <div style="text-align:center; margin-bottom:15px; padding: 10px; background: #fffbe6; border-radius: 10px;">
                <h2 id="history-archer-name" style="margin:0; font-size:1.2rem;"></h2>
                <div style="font-size:0.8rem; color:#666;">é»æ“Šç´€éŒ„æŸ¥çœ‹è©³ç´°</div>
            </div>
            <div id="history-list-container"></div>
            <button class="home-btn btn-blue" style="margin-top:20px;" onclick="navTo('view-calendar')">ğŸ“… é€²å…¥è¡Œäº‹æ›† / ç´€éŒ„æ–°æˆç¸¾</button>
        </div>
    </div>

    <div id="view-calendar" class="hidden">
        <div class="header">
            <button class="btn-header" onclick="handleCalendarBack()">â¬… è¿”å›</button>
            <h1 id="calendar-title">è¡Œäº‹æ›†</h1>
            <div style="width: 60px;"></div>
        </div>
        <div class="scroll-content">
            <div style="text-align:center; margin-bottom:10px;">
                <span style="background:#eee; padding:5px 15px; border-radius:15px; font-size:0.9rem; color:#555;">
                    ç•¶å‰æŸ¥çœ‹ï¼š<strong id="current-archer-display">---</strong>
                </span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; padding: 0 10px;">
                <button onclick="changeMonth(-1)" style="border:none; background:transparent; font-size:1.5rem;">â—€</button>
                <h2 id="month-display" style="margin:0;"></h2>
                <button onclick="changeMonth(1)" style="border:none; background:transparent; font-size:1.5rem;">â–¶</button>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
    </div>

    <div id="view-score" class="hidden">
        <div class="header">
            <button class="btn-header" onclick="goBackFromScore()">â¬… è¿”å›</button>
            <h1 id="score-header-title">è¨ˆåˆ†æ¿</h1>
            <button class="btn-header" style="color:var(--stamp-red);" onclick="saveCurrentRound()">ğŸ’¾ å„²å­˜</button>
        </div>

        <div class="top-toolbar">
            <select id="round-selector" class="round-selector" onchange="switchRound()"></select>
            <button class="btn-tool" onclick="exportPDF()">ğŸ“„ PDF</button>
            <button class="btn-tool" style="border-color:var(--primary-blue);" onclick="toggleKeypad()">âŒ¨ï¸ éµç›¤</button>
        </div>
        
        <div class="scroll-content">
            <div id="pdf-export-area" class="pdf-area">
                <div class="controls-info">
                    <span id="date-label" style="font-weight:bold;"></span>
                    <span id="pdf-archer-name" style="color:#555;"></span>
                </div>
                <div class="controls-info" style="margin-top:5px; border-bottom: 2px dashed #eee; padding-bottom:5px;">
                     <span id="round-label-display" style="color:var(--stamp-red); font-weight:bold;">Round 1</span>
                     <select id="mode-select" onchange="initScoreTable()" style="padding:2px; border-radius:5px;">
                        <option value="outdoor">å®¤å¤– (36ç®­)</option>
                        <option value="indoor">å®¤å…§ (30ç®­)</option>
                    </select>
                </div>

                <table class="score-table">
                    <thead><tr id="table-head-row"></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>

                <div class="total-display">
                    ç¸½åˆ†ï¼š<span id="grand-total">0</span>
                </div>

                <div class="signature-area">
                    <div class="sig-box" onclick="handleSign('archer')">
                        <div id="sig-archer" class="sig-placeholder">é»æ“Šç°½åˆ°</div>
                        <small>å°„æ‰‹</small>
                    </div>
                    <div class="sig-box" onclick="handleSign('coach')">
                        <div id="sig-coach" class="sig-placeholder">é»æ“Šç°½ç½²</div>
                        <small>æ•™ç·´</small>
                    </div>
                </div>
                <div class="comment-section">
                    <label style="font-weight:bold;">ğŸ“‹ æ•™ç·´è©•èªï¼š</label>
                    <textarea id="coach-comment" class="comment-box" placeholder="è«‹è¼¸å…¥è©•èª..."></textarea>
                </div>
                
                <div class="photo-section">
                    <input type="file" id="target-photo-input" accept="image/*" style="display:none;" onchange="handlePhotoUpload(event)">
                    <button class="btn-camera" onclick="document.getElementById('target-photo-input').click()">ğŸ“· æ‹æ”/ä¸Šå‚³é¶é¢</button>
                    <div id="photo-preview-container" class="photo-preview-container">
                        <img id="photo-preview" class="photo-preview" src="">
                        <button class="btn-delete-photo" onclick="deletePhoto()">Ã—</button>
                    </div>
                </div>

                <div style="text-align:center; margin-top:10px; color:#ccc; font-size:0.7rem;">
                    Generated by Yoyo Archery App
                </div>
            </div>
        </div>

        <div class="keypad-container" id="keypad">
            <div class="key-row"><button class="key-btn k-y" onclick="inputScore('X')">X</button> <button class="key-btn k-y" onclick="inputScore(10)">10</button> <button class="key-btn k-y" onclick="inputScore(9)">9</button></div>
            <div class="key-row"><button class="key-btn k-r" onclick="inputScore(8)">8</button> <button class="key-btn k-r" onclick="inputScore(7)">7</button> <button class="key-btn k-b" onclick="inputScore(6)">6</button> <button class="key-btn k-b" onclick="inputScore(5)">5</button></div>
            <div class="key-row"><button class="key-btn k-bk" onclick="inputScore(4)">4</button> <button class="key-btn k-bk" onclick="inputScore(3)">3</button> <button class="key-btn k-w" onclick="inputScore(2)">2</button> <button class="key-btn k-w" onclick="inputScore(1)">1</button></div>
            <div class="key-row"><button class="key-btn k-w" onclick="inputScore('M')">M</button> <button class="key-btn k-del" onclick="deleteScore()">â¬…</button> <button class="key-btn k-nav" onclick="moveFocus(1)">ä¸‹ä¸€æ ¼</button></div>
        </div>
    </div>

    <div id="emoji-modal" class="hidden modal-overlay">
        <div class="modal-box">
            <h3>é¸æ“‡é ­åƒ</h3>
            <div class="emoji-grid" id="emoji-grid"></div>
            <button style="margin-top:15px; border:none; background:none; color:#888;" onclick="closeEmojiSelector()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="login-modal" class="hidden modal-overlay">
        <div class="modal-box">
            <h3>ğŸ” æ•™ç·´ç™»å…¥</h3>
            <input type="password" id="coach-pwd" class="login-input" style="margin:10px 0;" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            <button class="home-btn btn-blue" style="margin:10px auto; padding:10px;" onclick="checkLogin()">ç™»å…¥</button>
            <button style="background:none; border:none; color:#888;" onclick="closeLogin()">å–æ¶ˆ</button>
        </div>
    </div>

</div>

<script>
    // --- 1. FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBfy1pe_3WIigOpZXXI3kASKqhxEsHWGO8",
        authDomain: "yoyo-archery-app.firebaseapp.com",
        projectId: "yoyo-archery-app",
        storageBucket: "yoyo-archery-app.firebasestorage.app",
        messagingSenderId: "540788690338",
        appId: "1:540788690338:web:6bed490f095102a8baf6fb",
        measurementId: "G-99R8BXR4L2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 2. é›²ç«¯é‚è¼¯ ---
    let currentRole = 'archer';
    let currentArcherName = ''; 
    let currentArcherAvatar = 'ğŸ»';
    let selectedDate = new Date().toISOString().split('T')[0];
    let displayMonth = new Date();
    let currentRoundData = {}; 
    let currentRoundIdx = 0;
    let localCacheData = {}; 
    let lastView = 'view-home'; 

    function showLoading(show, text="é€£ç·šä¸­...") {
        const el = document.getElementById('loading');
        document.getElementById('loading-text').innerText = text;
        if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
    }

    function loadCloudData(archerName, callback) {
        showLoading(true, `è®€å– ${archerName} è³‡æ–™...`);
        db.collection("records").doc(archerName).get().then((doc) => {
            if (doc.exists) {
                const data = doc.data();
                localCacheData = data.appData ? JSON.parse(data.appData) : {};
            } else { localCacheData = {}; }
            showLoading(false);
            if(callback) callback();
        }).catch((error) => {
            showLoading(false); alert("è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
        });
    }

    function saveToCloud(callback) {
        if(!currentArcherName) return;
        showLoading(true, "æ­£åœ¨å„²å­˜...");
        db.collection("records").doc(currentArcherName).set({
            avatar: currentArcherAvatar, 
            appData: JSON.stringify(localCacheData),
            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            showLoading(false); if(callback) callback();
        }).catch((error) => {
            showLoading(false); alert("å„²å­˜å¤±æ•—");
        });
    }

    // --- 3. é ­åƒé‚è¼¯ ---
    const avatarList = ['ğŸ»','ğŸ°','ğŸ±','ğŸ¶','ğŸ¦','ğŸ¯','ğŸ¼','ğŸ¨','ğŸ·','ğŸ¸','ğŸ™','ğŸ¦„','ğŸ','ğŸ','ğŸ¦‹','ğŸ¢','ğŸ¦–','ğŸ¬','ğŸ³','ğŸ¦‰','ğŸ¦…','ğŸ¦†','ğŸ§','ğŸ”','ğŸ²','ğŸŒµ','ğŸ€','ğŸ„','ğŸŒ»','ğŸŒ¹','ğŸŒ·','ğŸ”¥','âš¡','â­','ğŸŒŸ','ğŸ¯','ğŸ¹','ğŸ¥‡','ğŸ†','ğŸ‘‘','ğŸ¨','âš½','ğŸ€','ğŸ¾','ğŸ±','ğŸ²','ğŸš—','âœˆï¸','ğŸš€','ğŸ›¸'];
    function openEmojiSelector() {
        const grid = document.getElementById('emoji-grid'); grid.innerHTML = "";
        avatarList.forEach(emoji => {
            const btn = document.createElement('div'); btn.className = 'emoji-btn'; btn.innerText = emoji;
            btn.onclick = () => selectAvatar(emoji); grid.appendChild(btn);
        });
        document.getElementById('emoji-modal').classList.remove('hidden');
    }
    function closeEmojiSelector() { document.getElementById('emoji-modal').classList.add('hidden'); }
    function selectAvatar(emoji) {
        currentArcherAvatar = emoji; document.getElementById('current-avatar-btn').innerText = emoji; closeEmojiSelector();
    }

    // --- 4. æ•™ç·´å„€è¡¨æ¿èˆ‡æˆç¸¾ç¸½è¦½ ---
    function loadAllArchers() {
        showLoading(true, "ç²å–åå–®...");
        db.collection("records").get().then((querySnapshot) => {
            const listContainer = document.getElementById('student-list-container'); listContainer.innerHTML = "";
            if (querySnapshot.empty) { listContainer.innerHTML = "<p style='grid-column:1/-1;text-align:center;'>æš«ç„¡ç´€éŒ„</p>"; }
            else {
                querySnapshot.forEach((doc) => {
                    const name = doc.id; const data = doc.data(); const avatar = data.avatar || 'ğŸ»';
                    const card = document.createElement('div'); card.className = 'student-card';
                    card.innerHTML = `<span class="student-icon">${avatar}</span><div class="student-name">${name}</div>`;
                    card.onclick = () => selectStudentForCoach(name, avatar);
                    listContainer.appendChild(card);
                });
            }
            showLoading(false);
        }).catch((err) => { showLoading(false); alert("éŒ¯èª¤: "+err.message); });
    }

    function selectStudentForCoach(name, avatar) {
        currentArcherName = name; currentArcherAvatar = avatar;
        updateUIForArcher(name);
        loadCloudData(name, () => {
            renderStudentHistory(name, avatar);
            navTo('view-student-history', 'coach');
        });
    }

    // è¨ˆç®—å¹³å‡åˆ†èˆ‡æ¸²æŸ“æ­·å²åˆ—è¡¨
    function renderStudentHistory(name, avatar) {
        document.getElementById('history-title').innerText = "æˆç¸¾ç¸½è¦½";
        document.getElementById('history-archer-name').innerText = `${avatar} ${name} çš„è¨“ç·´ç´€éŒ„`;
        const container = document.getElementById('history-list-container'); container.innerHTML = "";
        
        const historyList = [];
        Object.keys(localCacheData).forEach(date => {
            const dayData = localCacheData[date];
            if(dayData.rounds) {
                dayData.rounds.forEach((round, idx) => {
                    historyList.push({ date: date, roundIdx: idx, data: round });
                });
            }
        });
        historyList.sort((a, b) => new Date(b.date) - new Date(a.date));

        if(historyList.length === 0) { container.innerHTML = "<p style='text-align:center;color:#999;margin-top:20px;'>å°šæœªæœ‰ä»»ä½•ç´€éŒ„</p>"; return; }

        historyList.forEach(item => {
            const r = item.data;
            let arrowCount = 0;
            if(r.scores) { r.scores.forEach(row => { row.forEach(val => { if(val !== null && val !== "") arrowCount++; }); }); }
            const total = parseInt(r.total) || 0;
            const avg = arrowCount > 0 ? (total / arrowCount).toFixed(1) : "0.0";
            const modeText = r.mode === 'indoor' ? 'å®¤å…§' : 'å®¤å¤–';

            const div = document.createElement('div'); div.className = 'history-card';
            div.innerHTML = `
                <div><div class="h-date">${item.date} â€¢ Round ${item.roundIdx + 1}</div><div class="h-title">${modeText}è³½ (${arrowCount}ç®­)</div><div class="h-stats"><span class="stat-badge">ç¸½åˆ†: ${total}</span><span class="stat-badge stat-avg">å‡åˆ†: ${avg}</span>${r.coachSigned ? '<span class="stat-badge" style="color:var(--stamp-red)">ğŸ’®å·²ç°½</span>' : ''}</div></div><div class="arrow-right">â€º</div>
            `;
            div.onclick = () => { lastView = 'view-student-history'; openScorePage(item.date, item.roundIdx); };
            container.appendChild(div);
        });
    }

    // --- 5. å°èˆªèˆ‡ç™»å…¥ ---
    function loginArcher() {
        const name = document.getElementById('archer-name-input').value.trim();
        if(!name) { alert("è«‹è¼¸å…¥åå­—"); return; }
        currentArcherName = name; updateUIForArcher(name);
        loadCloudData(name, () => { 
            renderStudentHistory(name, currentArcherAvatar);
            navTo('view-student-history', 'archer'); 
        });
    }
    function updateUIForArcher(name) {
        document.getElementById('current-archer-display').innerText = `${currentArcherAvatar} ${name}`;
        document.getElementById('pdf-archer-name').innerText = `å°„æ‰‹: ${currentArcherAvatar} ${name}`;
    }
    
    function handleHistoryBack() {
        if(currentRole === 'coach') navTo('view-coach-dashboard'); 
        else navTo('view-home'); 
    }
    function handleCalendarBack() {
        navTo('view-student-history'); 
    }
    function goBackFromScore() {
        if(lastView === 'view-student-history') navTo('view-student-history');
        else navTo('view-calendar');
    }

    function navTo(viewId, role) {
        if(role) currentRole = role;
        ['view-home', 'view-coach-dashboard', 'view-student-history', 'view-calendar', 'view-score'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(viewId).classList.remove('hidden');
        
        if(viewId === 'view-calendar') { lastView = 'view-calendar'; renderCalendar(); }
        if(viewId === 'view-score') document.getElementById('keypad').classList.remove('hidden-keypad');

        const color = currentRole === 'coach' ? 'var(--primary-blue)' : 'var(--primary-pink)';
        document.querySelectorAll('.header').forEach(h => h.style.background = color);
    }

    function openLogin() { document.getElementById('login-modal').classList.remove('hidden'); }
    function closeLogin() { document.getElementById('login-modal').classList.add('hidden'); }
    function checkLogin() {
        const pwd = document.getElementById('coach-pwd').value;
        if(pwd === '7201440') { closeLogin(); navTo('view-coach-dashboard', 'coach'); loadAllArchers(); }
        else { alert('å¯†ç¢¼éŒ¯èª¤'); }
    }

    // --- 6. æœˆæ›†ã€è¨ˆåˆ†èˆ‡å…¶ä»–é‚è¼¯ ---
    function renderCalendar() {
        const grid = document.getElementById('calendar-grid'); grid.innerHTML = "";
        const y = displayMonth.getFullYear(); const m = displayMonth.getMonth();
        document.getElementById('month-display').innerText = `${y}å¹´ ${m+1}æœˆ`;
        const days = new Date(y, m+1, 0).getDate(); const firstDay = new Date(y, m, 1).getDay();
        const dbData = localCacheData; 
        for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
        for(let d=1; d<=days; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const el = document.createElement('div'); el.className = 'cal-day';
            const num = document.createElement('div'); num.className='cal-num'; num.innerText=d; el.appendChild(num);
            if(dateStr === new Date().toISOString().split('T')[0]) el.classList.add('today');
            const dayData = dbData[dateStr];
            if(dayData && dayData.rounds && dayData.rounds.length > 0) {
                const scoreList = document.createElement('div'); scoreList.className = 'cal-scores';
                dayData.rounds.forEach((r, idx) => { if(idx < 3) { const row = document.createElement('div'); row.innerText = `R${idx+1}: ${r.total}`; scoreList.appendChild(row); } });
                if(dayData.rounds.length > 3) { const more=document.createElement('div'); more.innerText="..."; scoreList.appendChild(more); }
                el.appendChild(scoreList); el.style.background = '#fffbe6';
                if(dayData.rounds.some(r => r.coachSigned)) { const s = document.createElement('div'); s.className = 'stamp-mark'; s.innerText = 'ğŸ’®'; el.appendChild(s); }
            }
            el.onclick = () => { lastView='view-calendar'; openScorePage(dateStr); }; // å¾æ—¥æ›†é€²
            grid.appendChild(el);
        }
    }
    function changeMonth(d) { displayMonth.setMonth(displayMonth.getMonth() + d); renderCalendar(); }

    function openScorePage(dateStr, specificRoundIdx = null) {
        selectedDate = dateStr;
        navTo('view-score');
        document.getElementById('date-label').innerText = dateStr;
        
        let dayData = localCacheData[dateStr];
        if (!dayData || !dayData.rounds) { dayData = { rounds: [] }; }
        if (dayData.rounds.length === 0) { createEmptyRound(dayData); }

        currentRoundIdx = (specificRoundIdx !== null) ? specificRoundIdx : dayData.rounds.length - 1;
        
        localCacheData[dateStr] = dayData;
        renderRoundSelector(dayData);
        loadRoundData(dayData.rounds[currentRoundIdx]);
        document.getElementById('coach-comment').readOnly = (currentRole === 'archer');
    }

    function createEmptyRound(dayData) { dayData.rounds.push({ mode: 'outdoor', scores: null, total: 0, comment: '', archerSigned: false, coachSigned: false, targetPhoto: null }); return dayData.rounds.length - 1; }
    function renderRoundSelector(dayData) {
        const sel = document.getElementById('round-selector'); sel.innerHTML = "";
        dayData.rounds.forEach((r, idx) => { const opt = document.createElement('option'); opt.value = idx; opt.text = `R${idx + 1} (${r.total})`; sel.appendChild(opt); });
        const add = document.createElement('option'); add.value = "new"; add.text = "â• æ–°å¢"; sel.appendChild(add);
        sel.value = currentRoundIdx;
    }
    function switchRound() {
        const val = document.getElementById('round-selector').value; updateCurrentRoundData();
        let dayData = localCacheData[selectedDate];
        if (val === "new") {
            if(confirm("é–‹å§‹æ–°çš„ä¸€è¼ªï¼Ÿ")) { currentRoundIdx = createEmptyRound(dayData); renderRoundSelector(dayData); loadRoundData(dayData.rounds[currentRoundIdx]); } else { document.getElementById('round-selector').value = currentRoundIdx; }
        } else { currentRoundIdx = parseInt(val); loadRoundData(dayData.rounds[currentRoundIdx]); }
    }
    function loadRoundData(r) {
        currentRoundData = r;
        document.getElementById('mode-select').value = r.mode || 'outdoor';
        document.getElementById('coach-comment').value = r.comment || '';
        document.getElementById('round-label-display').innerText = `Round ${currentRoundIdx + 1}`;
        // ç…§ç‰‡è¼‰å…¥é‚è¼¯
        const preview = document.getElementById('photo-preview');
        const container = document.getElementById('photo-preview-container');
        if(r.targetPhoto) {
            preview.src = r.targetPhoto; container.style.display = 'block';
        } else {
            preview.src = ""; container.style.display = 'none';
        }
        initScoreTable(false); updateSigUI('archer', r.archerSigned); updateSigUI('coach', r.coachSigned);
    }
    function updateCurrentRoundData() {
        currentRoundData.mode = document.getElementById('mode-select').value; currentRoundData.scores = scores; currentRoundData.total = document.getElementById('grand-total').innerText;
        currentRoundData.comment = document.getElementById('coach-comment').value; currentRoundData.archerSigned = document.getElementById('sig-archer').innerHTML.includes('stamp-img');
        currentRoundData.coachSigned = document.getElementById('sig-coach').innerHTML.includes('stamp-img');
        // ç…§ç‰‡å·²åœ¨ handlePhotoUpload å³æ™‚æ›´æ–°åˆ° currentRoundData
    }
    function saveCurrentRound() {
        updateCurrentRoundData();
        if(!localCacheData[selectedDate]) localCacheData[selectedDate] = { rounds: [] };
        localCacheData[selectedDate].rounds[currentRoundIdx] = currentRoundData;
        renderRoundSelector(localCacheData[selectedDate]);
        saveToCloud(() => { alert('âœ… é›²ç«¯åŒæ­¥æˆåŠŸï¼'); });
    }

    // --- V18 ç…§ç‰‡é‚è¼¯ ---
    function handlePhotoUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        showLoading(true, "è™•ç†ç…§ç‰‡ä¸­...");
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                // å£“ç¸®é‚è¼¯
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const MAX_WIDTH = 600; 
                let width = img.width; let height = img.height;
                
                if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                canvas.width = width; canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6); // 0.6 å“è³ª
                currentRoundData.targetPhoto = dataUrl; // å­˜å…¥è¨˜æ†¶é«”
                
                // æ›´æ–° UI
                document.getElementById('photo-preview').src = dataUrl;
                document.getElementById('photo-preview-container').style.display = 'block';
                showLoading(false);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function deletePhoto() {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç…§ç‰‡ï¼Ÿ")) {
            currentRoundData.targetPhoto = null;
            document.getElementById('photo-preview').src = "";
            document.getElementById('photo-preview-container').style.display = 'none';
            document.getElementById('target-photo-input').value = ""; // Reset input
        }
    }

    let scores = []; let currentFocus = { r: 0, c: 0 };
    function initScoreTable(reset) {
        const mode = document.getElementById('mode-select').value; const rows = (mode==='outdoor')?6:10; const arrows = (mode==='outdoor')?6:3;
        if(reset || !currentRoundData.scores) scores = Array(rows).fill().map(()=>Array(arrows).fill(null)); else scores = currentRoundData.scores;
        const thead = document.getElementById('table-head-row'); let h = '<th width="12%">è¶Ÿ</th>'; for(let i=1;i<=arrows;i++) h+=`<th>${i}</th>`; h+='<th width="15%">å°è¨ˆ</th>'; thead.innerHTML=h;
        const tbody = document.getElementById('table-body'); tbody.innerHTML="";
        for(let r=0;r<rows;r++) {
            const tr=document.createElement('tr'); tr.innerHTML=`<td style="background:#f0f8ff;font-weight:bold;">${r+1}</td>`;
            for(let c=0;c<arrows;c++) tr.innerHTML+=`<td><div id="cell-${r}-${c}" class="score-cell" onclick="setFocus(${r},${c})"></div></td>`;
            tr.innerHTML+=`<td id="sub-${r}" style="font-weight:bold;color:#555;">0</td>`; tbody.appendChild(tr);
        }
        refreshTableUI(); setFocus(0,0);
    }
    function refreshTableUI() {
        scores.forEach((row,r)=>{ let sub=0; row.forEach((v,c)=>{
            const cell=document.getElementById(`cell-${r}-${c}`); if(cell){cell.innerText=v===null?'':v;applyColor(cell,v);}
            if(v==='X')sub+=10; else if(v!=='M'&&v!==null)sub+=parseInt(v);
        }); document.getElementById(`sub-${r}`).innerText=sub; });
        updateTotal();
    }
    function applyColor(el,v) { el.className="score-cell active"; if(v==='X'||v==10||v==9)el.classList.add('bg-yellow'); else if(v==8||v==7)el.classList.add('bg-red'); else if(v==6||v==5)el.classList.add('bg-blue'); else if(v==4||v==3)el.classList.add('bg-black'); else el.classList.add('bg-white'); }
    function updateTotal(){ let t=0; scores.forEach(row=>{row.forEach(v=>{if(v==='X')t+=10;else if(v!=='M'&&v!==null)t+=parseInt(v);});}); document.getElementById('grand-total').innerText=t; }
    
    function toggleKeypad() { document.getElementById('keypad').classList.toggle('hidden-keypad'); }
    document.getElementById('coach-comment').addEventListener('focus', () => { document.getElementById('keypad').classList.add('hidden-keypad'); });
    function setFocus(r,c){ const old=document.querySelector('.score-cell.active'); if(old)old.classList.remove('active'); currentFocus={r,c}; document.getElementById(`cell-${r}-${c}`).classList.add('active'); document.getElementById('keypad').classList.remove('hidden-keypad'); }
    function moveFocus(step){ const rows=scores.length; const cols=scores[0].length; let {r,c}=currentFocus; c+=step; if(c>=cols){c=0;r++;} if(c<0){c=cols-1;r--;} if(r>=0&&r<rows)setFocus(r,c); }
    function inputScore(v){ if(scores[currentFocus.r]){scores[currentFocus.r][currentFocus.c]=v; refreshTableUI(); moveFocus(1);} }
    function deleteScore(){ scores[currentFocus.r][currentFocus.c]=null; refreshTableUI(); }
    
    function handleSign(role){ if(currentRole!==role){alert(`è«‹ä»¥ ${role==='coach'?'æ•™ç·´':'å°„æ‰‹'} èº«åˆ†ç™»å…¥`);return;} const div=document.getElementById(`sig-${role}`); updateSigUI(role,!div.innerHTML.includes('stamp-img')); }
    function updateSigUI(role,signed){ const div=document.getElementById(`sig-${role}`); if(signed){div.innerHTML=`<div class="stamp-img">${role==='archer'?'å·²ç°½':'èªè­‰'}</div>`; div.style.borderBottom="none";} else{div.innerHTML=role==='archer'?'é»æ“Šç°½åˆ°':'é»æ“Šç°½ç½²'; div.style.borderBottom="2px solid #ccc";} }
    
    function exportPDF(){ document.getElementById('keypad').classList.add('hidden-keypad'); const el=document.getElementById('pdf-export-area'); const opt={margin:0.2, filename:`å°„ç®­_${selectedDate}_${currentArcherName}_R${currentRoundIdx+1}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'a4',orientation:'portrait'}}; html2pdf().set(opt).from(el).save(); }

</script>
</body>
</html>